{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/sales_invoice_detail.css' %}">
{% endblock %}

{% block page_actions %}
<div class="invoice-detail-page-actions">
    <button type="button" class="edit-invoice-action-btn" data-bs-toggle="modal" data-bs-target="#editSalesInvoiceModal">
        <i class="fas fa-edit me-2"></i>Edit Invoice
    </button>
    <a href="{% url 'print_receipt' pk=invoice.sales_invoice_no %}" target="_blank" class="print-bill-action-btn" title="Print Receipt (Ctrl+P)">
        <i class="fas fa-receipt me-2"></i>Print Receipt (Ctrl+P)
    </a>
    <a href="{% url 'print_sales_bill' pk=invoice.sales_invoice_no %}" target="_blank" class="print-bill-action-btn">
        <i class="fas fa-print me-2"></i>Print Bill
    </a>
    {% if invoice.balance_due > 0 %}
    <button type="button" onclick="openAddSalesPaymentDialog()" class="add-payment-action-btn">
        <i class="fas fa-money-bill-wave me-2"></i>Add Payment
    </button>
    {% endif %}
    {% if request.user.user_type == 'admin' %}
    <a href="{% url 'delete_sales_invoice' pk=invoice.sales_invoice_no %}" class="delete-invoice-action-btn">
        <i class="fas fa-trash me-2"></i>Delete Invoice
    </a>
    {% endif %}
    <a href="{% url 'sales_invoice_list' %}" class="back-to-invoices-action-btn">
        <i class="fas fa-arrow-left me-2"></i>Back to Invoices
    </a>
</div>
{% endblock %}

{% block content %}
<div class="sales-invoice-detail-container">
    <div class="invoice-summary-section">
        <div class="invoice-info-card">
            <div class="invoice-info-header">
                <h5 class="invoice-info-title">Invoice Information</h5>
                <button type="button" class="edit-invoice-header-btn" onclick="document.getElementById('editSalesInvoiceModal').style.display='block'">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
            <div class="invoice-info-body">
                <div class="invoice-basic-details">
                    <div class="invoice-number-display">
                        <h6 class="invoice-number-label">Invoice No.</h6>
                        <h4 class="invoice-number-value">{{ invoice.sales_invoice_no }}</h4>
                    </div>
                    <div class="invoice-date-display">
                        <h6 class="invoice-date-label">Date</h6>
                        <h4 class="invoice-date-value">{{ invoice.sales_invoice_date }}</h4>
                    </div>
                </div>
                
                <div class="customer-info-display">
                    <h6 class="customer-info-label">Customer</h6>
                    <h5 class="customer-info-value">
                        <a href="{% url 'customer_detail' pk=invoice.customerid.customerid %}" class="customer-detail-link">
                            {{ invoice.customerid.customer_name }}
                        </a>
                    </h5>
                </div>
                
                <div class="invoice-total-section">
                    <div class="invoice-total-display">
                        <h6 class="invoice-total-label">Invoice Total</h6>
                        <h5 class="invoice-total-value">{{ invoice.sales_invoice_total|currency }}</h5>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="payment-status-card">
            <div class="payment-status-header">
                <h5 class="payment-status-title">Payment Status</h5>
            </div>
            <div class="payment-status-body">
                <div class="payment-progress-wrapper">
                    {% if invoice.sales_invoice_total > 0 %}
                    <div class="payment-progress-bar" role="progressbar" style="width: {{ invoice.sales_invoice_paid|divide:invoice.sales_invoice_total|multiply:100 }}%;" aria-valuenow="{{ invoice.sales_invoice_paid|divide:invoice.sales_invoice_total|multiply:100 }}" aria-valuemin="0" aria-valuemax="100">
                        <span class="payment-progress-text">{{ invoice.sales_invoice_paid|divide:invoice.sales_invoice_total|multiply:100|floatformat:1 }}%</span>
                    </div>
                    {% else %}
                    <div class="payment-progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <span class="payment-progress-text">0%</span>
                    </div>
                    {% endif %}
                </div>
                
                <div class="payment-amounts-section">
                    <div class="total-paid-display">
                        <h6 class="total-paid-label">Total Paid</h6>
                        <h5 class="total-paid-value">{{ invoice.sales_invoice_paid|currency }}</h5>
                    </div>
                    <div class="balance-due-display">
                        <h6 class="balance-due-label">Balance Due</h6>
                        <h5 class="balance-due-value {% if invoice.sales_invoice_total > invoice.sales_invoice_paid %}text-danger{% else %}text-success{% endif %}">
                            {{ invoice.sales_invoice_total|subtract:invoice.sales_invoice_paid|currency }}
                        </h5>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="payment-history-card">
            <div class="payment-history-header">
                <h5 class="payment-history-title">Payment History</h5>
                {% if invoice.sales_invoice_total > invoice.sales_invoice_paid %}
                <button type="button" onclick="openAddSalesPaymentDialog()" class="add-payment-btn">
                    <i class="fas fa-plus"></i>
                </button>
                {% endif %}
            </div>
            <div class="payment-history-body">
                <div class="payment-history-table-wrapper">
                    <table class="payment-history-table">
                        <thead class="payment-history-table-header">
                            <tr class="payment-history-header-row">
                                <th class="payment-date-header">Date</th>
                                <th class="payment-amount-header">Amount</th>
                                <th class="payment-mode-header">Mode</th>
                                <th class="payment-reference-header">Reference</th>
                            </tr>
                        </thead>
                        <tbody class="payment-history-table-body">
                            {% for payment in payments %}
                            <tr class="payment-history-row">
                                <td class="payment-date-cell">
                                    {% if payment.sales_payment_date %}
                                        {{ payment.sales_payment_date|date:"d/m/Y" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="payment-amount-cell">{{ payment.sales_payment_amount|currency }}</td>
                                <td class="payment-mode-cell">{{ payment.sales_payment_mode }}</td>
                                <td class="payment-reference-cell">{{ payment.sales_payment_ref_no }}</td>
                            </tr>
                            {% empty %}
                            <tr class="no-payments-row">
                                <td colspan="4" class="no-payments-cell">No payments recorded</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="products-section">
        <div class="products-card">
            <div class="products-header">
                <h5 class="products-title">Products</h5>

            </div>
            <div class="products-body">
                <div class="products-table-wrapper">
                    <table class="products-table">
                        <thead class="products-table-header">
                            <tr class="products-header-row">
                                <th class="product-name-header">Product</th>
                                <th class="batch-no-header">Batch No</th>
                                <th class="expiry-header">Expiry</th>
                                <th class="rate-type-header">Rate Type</th>
                                <th class="rate-header">Rate</th>
                                <th class="quantity-header">Qty</th>
                                <th class="discount-header">Discount</th>
                                <th class="gst-header">GST %</th>
                                <th class="total-header">Total</th>
                                <th class="actions-header">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="products-table-body">
                            {% for sale in sales %}
                            <tr class="product-row">
                                <td class="product-name-cell">
                                    <a href="{% url 'product_detail' pk=sale.productid.productid %}" class="product-detail-link">
                                        {{ sale.product_name }}
                                    </a>
                                    <div class="product-company-info">{{ sale.product_company }} - {{ sale.product_packing }}</div>
                                </td>
                                <td class="batch-no-cell">{{ sale.product_batch_no }}</td>
                                <td class="expiry-cell">{{ sale.product_expiry|expiry_mmyyyy }}</td>
                                <td class="rate-type-cell">{{ sale.rate_applied }}</td>
                                <td class="rate-cell">{{ sale.sale_rate|currency }}</td>
                                <td class="quantity-cell">{{ sale.sale_quantity|floatformat:2 }}</td>
                                <td class="discount-cell">
                                    {% if sale.sale_calculation_mode == 'flat' %}
                                        {{ sale.sale_discount|currency }}
                                    {% else %}
                                        {{ sale.sale_discount }}%
                                    {% endif %}
                                </td>
                                <td class="gst-cell">{{ sale.sale_igst }}%</td>
                                <td class="total-cell">{{ sale.sale_total_amount|currency }}</td>
                                <td class="actions-cell">
                                    <div class="product-actions">
                                        <button type="button" onclick="confirmDeleteSale({{ sale.id }}, '{{ sale.product_name|escapejs }}')" class="delete-product-btn">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr class="no-products-row">
                                <td colspan="10" class="no-products-cell">No products added to this invoice</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="products-table-footer">
                            <tr class="total-row">
                                <td colspan="9" class="total-label-cell"><strong>Total:</strong></td>
                                <td class="total-value-cell">{{ invoice.sales_invoice_total|currency }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Sales Invoice Modal -->
<div class="modal fade" id="editSalesInvoiceModal" tabindex="-1" aria-labelledby="editSalesInvoiceModalLabel" style="display: none;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSalesInvoiceModalLabel">Edit Sales Invoice #{{ invoice.sales_invoice_no }}</h5>
                <button type="button" class="btn-close" onclick="document.getElementById('editSalesInvoiceModal').style.display='none'" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editSalesInvoiceForm">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="edit_sales_invoice_no" class="form-label">Invoice No</label>
                            <input type="text" class="form-control" id="edit_sales_invoice_no" name="sales_invoice_no" value="{{ invoice.sales_invoice_no }}" readonly>
                            <small class="form-text text-muted">Invoice number cannot be changed</small>
                        </div>
                        <div class="col-md-4">
                            <label for="edit_sales_invoice_date" class="form-label">Invoice Date</label>
                            <input type="date" class="form-control" id="edit_sales_invoice_date" name="sales_invoice_date" value="{{ invoice.sales_invoice_date|date:'Y-m-d' }}" autofocus required>
                        </div>
                        <div class="col-md-4">
                            <label for="edit_customerid" class="form-label">Customer</label>
                            <select class="form-select" id="edit_customerid" name="customerid" onchange="fetchEditCustomerRateInfo(this.value)" required>
                                {% for customer in customers %}
                                <option value="{{ customer.customerid }}" {% if customer.customerid == invoice.customerid.customerid %}selected{% endif %}>
                                    {{ customer.customer_name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div id="editCustomerRateInfo" class="customer-rate-info" style="display: none; margin-top: 8px; padding: 8px; background: #d4edda; border-radius: 4px; border-left: 3px solid #28a745;">
                                <small class="customer-rate-text" style="color: #155724; font-weight: 500; font-size: 0.75rem;"></small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="products-section">
                        <div class="products-header-edit">
                            <h6>Products</h6>
                            <div class="edit-shortcuts">
                                <small class="keyboard-shortcuts">âš¡ F2 (Quick Search), Alt+W (Batch Selection), Ctrl+Enter (Add Row)</small>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered" id="editProductsTable">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Batch No</th>
                                        <th>Expiry</th>
                                        <th>MRP</th>
                                        <th>Rate</th>
                                        <th>Qty</th>
                                        <th>Discount</th>
                                        <th>GST %</th>
                                        <th>Total</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="editProductRows">
                                    {% for sale in sales %}
                                    <tr class="product-row" data-row-index="{{ forloop.counter0 }}" id="editProductRow_{{ forloop.counter0 }}">
                                        <td>
                                            <select class="form-select product-select" name="productid" onchange="loadEditProductDetails(this, {{ forloop.counter0 }})" required>
                                                <option value="">Select Product</option>
                                                {% for product in products %}
                                                <option value="{{ product.productid }}" {% if product.productid == sale.productid.productid %}selected{% endif %}>
                                                    {{ product.product_name }} - {{ product.product_company }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control batch-no" name="batch_no" value="{{ sale.product_batch_no }}" required>
                                            <div class="stock-error" style="display: none; color: #dc3545; font-size: 0.75rem; margin-top: 4px;"></div>
                                        </td>
                                        <td><input type="text" class="form-control expiry" name="expiry" value="{{ sale.product_expiry|expiry_mmyyyy }}" placeholder="MM-YYYY"></td>
                                        <td><input type="number" class="form-control mrp" name="mrp" value="{{ sale.product_MRP }}" step="0.01" min="0"></td>
                                        <td><input type="number" class="form-control rate" name="sale_rate" value="{{ sale.sale_rate }}" step="0.01" min="0" required></td>
                                        <td>
                                            <input type="number" class="form-control quantity" name="quantity" value="{{ sale.sale_quantity }}" step="0.01" min="0.01" 
                                                   oninput="validateEditStockAndCalculate({{ forloop.counter0 }})" 
                                                   onchange="validateEditStockAndCalculate({{ forloop.counter0 }})" required>
                                            <div class="stock-error" style="display: none; color: #dc3545; font-size: 0.75rem; margin-top: 4px;"></div>
                                        </td>
                                        <td><input type="number" class="form-control discount" name="discount" value="{{ sale.sale_discount }}" step="0.01" min="0"></td>
                                        <td><input type="number" class="form-control igst" name="igst" value="{{ sale.sale_igst }}" step="0.01" min="0"></td>
                                        <td><input type="number" class="form-control total" name="total" value="{{ sale.sale_total_amount }}" readonly></td>
                                        <td><button type="button" class="btn btn-danger btn-sm remove-product"><i class="fas fa-trash"></i></button></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-secondary" id="addEditProductRow">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </div>
                    
                    <input type="hidden" id="editProductsData" name="products_data">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('editSalesInvoiceModal').style.display='none'">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEditSalesInvoice">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Add Sales Payment Dialog - Compact with Enhanced CSS
function openAddSalesPaymentDialog() {
    const existingDialog = document.getElementById('addSalesPaymentDialog');
    if (existingDialog) existingDialog.remove();
    
    const today = new Date().toISOString().split('T')[0];
    const balance = {{ invoice.sales_invoice_total|subtract:invoice.sales_invoice_paid }};
    
    const dialogHTML = `
        <div id="addSalesPaymentDialog" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 10002; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s ease;">
            <div style="background: white; border-radius: 16px; width: 90%; max-width: 480px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); animation: slideUp 0.3s ease; overflow: hidden;">
                <div style="background: linear-gradient(135deg, #27ae60, #229954); color: white; padding: 1.1rem 1.3rem; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600;"><i class="fas fa-money-bill-wave" style="margin-right: 8px;"></i>Add Payment</h3>
                    <button onclick="closeSalesPaymentDialog()" style="background: none; border: none; color: white; font-size: 26px; cursor: pointer; line-height: 1; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='none'">&times;</button>
                </div>
                <div style="padding: 1.3rem;">
                    <form id="addSalesPaymentForm" method="post">
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 0.9rem; border-radius: 10px; margin-bottom: 1.1rem; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #27ae60;">
                            <span style="font-weight: 500; color: #2c3e50; font-size: 0.95rem;">Balance Due:</span>
                            <strong style="color: #27ae60; font-size: 1.35rem; font-weight: 700;">â‚¹${balance.toFixed(2)}</strong>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.9rem; margin-bottom: 0.9rem;">
                            <div style="display: flex; flex-direction: column;">
                                <label style="font-weight: 600; margin-bottom: 0.4rem; color: #2c3e50; font-size: 0.85rem;">Amount <span style="color: #e74c3c;">*</span></label>
                                <input type="number" name="sales_payment_amount" step="0.01" min="0.01" max="${balance}" value="${balance}" required autofocus style="padding: 0.7rem; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#27ae60'" onblur="this.style.borderColor='#ddd'">
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <label style="font-weight: 600; margin-bottom: 0.4rem; color: #2c3e50; font-size: 0.85rem;">Date <span style="color: #e74c3c;">*</span></label>
                                <input type="date" name="sales_payment_date" value="${today}" required style="padding: 0.7rem; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#27ae60'" onblur="this.style.borderColor='#ddd'">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.9rem; margin-bottom: 0;">
                            <div style="display: flex; flex-direction: column;">
                                <label style="font-weight: 600; margin-bottom: 0.4rem; color: #2c3e50; font-size: 0.85rem;">Payment Mode <span style="color: #e74c3c;">*</span></label>
                                <select name="sales_payment_mode" required style="padding: 0.7rem; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95rem; background: white; cursor: pointer; transition: border-color 0.2s;" onfocus="this.style.borderColor='#27ae60'" onblur="this.style.borderColor='#ddd'">
                                    <option value="cash">Cash</option>
                                    <option value="cheque">Cheque</option>
                                    <option value="online">Online Transfer</option>
                                    <option value="upi">UPI</option>
                                </select>
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <label style="font-weight: 600; margin-bottom: 0.4rem; color: #2c3e50; font-size: 0.85rem;">Reference No</label>
                                <input type="text" name="sales_payment_ref_no" placeholder="Optional" style="padding: 0.7rem; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#27ae60'" onblur="this.style.borderColor='#ddd'">
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; gap: 0.7rem; margin-top: 1.3rem; padding-top: 1.1rem; border-top: 2px solid #f0f0f0;">
                            <button type="button" onclick="closeSalesPaymentDialog()" style="padding: 0.7rem 1.3rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; background: linear-gradient(135deg, #95a5a6, #7f8c8d); color: white; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)'"><i class="fas fa-times" style="margin-right: 5px;"></i>Cancel (Esc)</button>
                            <button type="submit" style="padding: 0.7rem 1.3rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; background: linear-gradient(135deg, #27ae60, #229954); color: white; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 8px rgba(39,174,96,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(39,174,96,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(39,174,96,0.3)'"><i class="fas fa-check" style="margin-right: 5px;"></i>Add Payment (Enter)</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <style>
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        </style>
    `;
    
    document.body.insertAdjacentHTML('beforeend', dialogHTML);
    setTimeout(() => {
        const amountInput = document.querySelector('#addSalesPaymentForm input[name="sales_payment_amount"]');
        if (amountInput) { amountInput.focus(); amountInput.select(); }
    }, 150);
    
    const form = document.getElementById('addSalesPaymentForm');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalHTML = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 5px;"></i>Processing...';
        submitBtn.disabled = true;
        
        const formData = new FormData(this);
        fetch('{% url "add_sales_payment" invoice_id=invoice.sales_invoice_no %}', {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Payment failed'));
                submitBtn.innerHTML = originalHTML;
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding payment. Please try again.');
            submitBtn.innerHTML = originalHTML;
            submitBtn.disabled = false;
        });
    });
    
    function handlePaymentDialogKeydown(e) {
        if (e.key === 'Escape') { e.preventDefault(); closeSalesPaymentDialog(); }
        else if (e.key === 'Enter' && e.target.tagName !== 'BUTTON' && e.target.type !== 'submit') {
            e.preventDefault();
            const submitBtn = document.querySelector('#addSalesPaymentForm button[type="submit"]');
            if (submitBtn && !submitBtn.disabled) submitBtn.click();
        }
    }
    
    document.addEventListener('keydown', handlePaymentDialogKeydown);
    window.paymentDialogKeyHandler = handlePaymentDialogKeydown;
}

function closeSalesPaymentDialog() {
    const dialog = document.getElementById('addSalesPaymentDialog');
    if (dialog) { dialog.style.animation = 'fadeOut 0.2s ease'; setTimeout(() => dialog.remove(), 200); }
    if (window.paymentDialogKeyHandler) {
        document.removeEventListener('keydown', window.paymentDialogKeyHandler);
        window.paymentDialogKeyHandler = null;
    }
}

// Edit Sales Invoice functionality
let editProductRowIndex = {{ sales|length }};
let selectedEditCustomerRateType = 'A'; // Default rate type

// Fetch customer rate info on page load
document.addEventListener('DOMContentLoaded', function() {
    const customerSelect = document.getElementById('edit_customerid');
    if (customerSelect && customerSelect.value) {
        fetchEditCustomerRateInfo(customerSelect.value);
    }
});

// Auto-focus on invoice date when edit modal opens
document.addEventListener('click', function(e) {
    if (e.target.matches('.edit-invoice-action-btn, .edit-invoice-header-btn') || 
        e.target.closest('.edit-invoice-action-btn, .edit-invoice-header-btn')) {
        setTimeout(() => {
            const invoiceDateField = document.getElementById('edit_sales_invoice_date');
            if (invoiceDateField) {
                invoiceDateField.focus();
                invoiceDateField.select();
            }
        }, 300);
    }
});

// Add product row in edit modal
document.getElementById('addEditProductRow').addEventListener('click', function() {
    const tbody = document.getElementById('editProductRows');
    const newRow = document.createElement('tr');
    newRow.className = 'product-row';
    newRow.setAttribute('data-row-index', editProductRowIndex);
    newRow.id = `editProductRow_${editProductRowIndex}`;
    
    newRow.innerHTML = `
        <td>
            <select class="form-select product-select" name="productid" onchange="loadEditProductDetails(this, ${editProductRowIndex})" required>
                <option value="">Select Product</option>
                {% for product in products %}
                <option value="{{ product.productid }}">{{ product.product_name }} - {{ product.product_company }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="text" class="form-control batch-no" name="batch_no" required>
            <div class="stock-error" style="display: none; color: #dc3545; font-size: 0.75rem; margin-top: 4px;"></div>
        </td>
        <td><input type="text" class="form-control expiry" name="expiry" placeholder="MM-YYYY"></td>
        <td><input type="number" class="form-control mrp" name="mrp" step="0.01" min="0"></td>
        <td><input type="number" class="form-control rate" name="sale_rate" step="0.01" min="0" required></td>
        <td>
            <input type="number" class="form-control quantity" name="quantity" step="0.01" min="0.01" 
                   oninput="validateEditStockAndCalculate(${editProductRowIndex})" 
                   onchange="validateEditStockAndCalculate(${editProductRowIndex})" required>
            <div class="stock-error" style="display: none; color: #dc3545; font-size: 0.75rem; margin-top: 4px;"></div>
        </td>
        <td><input type="number" class="form-control discount" name="discount" step="0.01" min="0" value="0"></td>
        <td><input type="number" class="form-control igst" name="igst" step="0.01" min="0" value="12"></td>
        <td><input type="number" class="form-control total" name="total" readonly></td>
        <td><button type="button" class="btn btn-danger btn-sm remove-product"><i class="fas fa-trash"></i></button></td>
    `;
    
    tbody.appendChild(newRow);
    editProductRowIndex++;
    
    // Add event listeners to new row
    addEditRowEventListeners(newRow);
    
    // Focus on product select
    setTimeout(() => {
        const productSelect = newRow.querySelector('.product-select');
        if (productSelect) {
            productSelect.focus();
        }
    }, 100);
});

// Remove product row
document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-product')) {
        e.target.closest('tr').remove();
    }
});

// Add event listeners to existing rows
document.querySelectorAll('#editProductRows .product-row').forEach(row => {
    addEditRowEventListeners(row);
});

function addEditRowEventListeners(row) {
    const quantityInput = row.querySelector('.quantity');
    const rateInput = row.querySelector('.rate');
    const discountInput = row.querySelector('.discount');
    const igstInput = row.querySelector('.igst');
    const batchInput = row.querySelector('.batch-no');
    
    // Add calculation listeners
    [rateInput, discountInput, igstInput].forEach(input => {
        if (input) {
            input.addEventListener('input', function() {
                calculateEditRowTotal(row);
            });
        }
    });
    
    // Add stock validation for quantity input
    if (quantityInput) {
        const rowIndex = row.getAttribute('data-row-index');
        
        quantityInput.addEventListener('input', function() {
            validateEditStockAndCalculate(rowIndex);
        });
        
        quantityInput.addEventListener('change', function() {
            validateEditStockAndCalculate(rowIndex);
        });
        
        quantityInput.addEventListener('blur', function() {
            validateEditStockAndCalculate(rowIndex);
        });
        
        // Prevent invalid characters
        quantityInput.addEventListener('keydown', function(e) {
            const allowedKeys = ['Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'];
            const isNumber = /[0-9]/.test(e.key);
            const isDecimal = e.key === '.' && !e.target.value.includes('.');
            
            if (!allowedKeys.includes(e.key) && !isNumber && !isDecimal && !(e.ctrlKey || e.metaKey)) {
                e.preventDefault();
            }
        });
    }
    
    // Add batch input debounced handler
    if (batchInput) {
        let batchTimeout;
        batchInput.addEventListener('input', function() {
            clearTimeout(batchTimeout);
            batchTimeout = setTimeout(() => {
                const productSelect = row.querySelector('.product-select');
                const rowIndex = row.getAttribute('data-row-index');
                
                if (productSelect && productSelect.value && this.value && this.value.length >= 2) {
                    fetchEditBatchDetails(productSelect.value, this.value, rowIndex);
                }
            }, 500);
        });
    }
}

// Fetch batch details for edit modal
function fetchEditBatchDetails(productId, batchNo, rowIndex) {
    const row = document.getElementById(`editProductRow_${rowIndex}`);
    const existingInfo = row.querySelector('.stock-info');
    if (existingInfo) {
        existingInfo.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    }
    
    fetch(`/api/batch-details/?product_id=${productId}&batch_no=${batchNo}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.warn('Edit batch details not found:', data.error);
                return;
            }
            
            fillEditBatchDetails(data, rowIndex);
        })
        .catch(error => {
            console.error('Error fetching edit batch details:', error);
            if (existingInfo) existingInfo.remove();
        });
}

function fillEditBatchDetails(data, rowIndex) {
    const row = document.getElementById(`editProductRow_${rowIndex}`);
    if (!row) return;
    
    console.log(`ðŸ“ Edit Filling batch details for row ${rowIndex}, customer rate: ${selectedEditCustomerRateType}`);
    
    // Auto-fill fields
    row.querySelector('.mrp').value = data.mrp || '';
    
    if (data.expiry) {
        row.querySelector('.expiry').value = data.expiry;
    }
    
    row.querySelector('.quantity').value = '1';
    row.querySelector('.discount').value = '0';
    row.querySelector('.igst').value = '12';
    
    // Set rate based on customer type with proper fallback
    let selectedRate = data.mrp || 0;
    let rateSource = 'MRP (Fallback)';
    
    if (data.rates) {
        if (selectedEditCustomerRateType === 'A' && data.rates.rate_A && data.rates.rate_A > 0) {
            selectedRate = data.rates.rate_A;
            rateSource = 'Rate A';
        } else if (selectedEditCustomerRateType === 'B' && data.rates.rate_B && data.rates.rate_B > 0) {
            selectedRate = data.rates.rate_B;
            rateSource = 'Rate B';
        } else if (selectedEditCustomerRateType === 'C' && data.rates.rate_C && data.rates.rate_C > 0) {
            selectedRate = data.rates.rate_C;
            rateSource = 'Rate C';
        }
    }
    
    console.log(`ðŸ’° Edit Batch Details Rate Applied: ${rateSource} = â‚¹${selectedRate}`);
    
    row.querySelector('.rate').value = selectedRate;
    
    // Show enhanced stock info with rate source
    const stockValue = data.available_stock !== undefined ? data.available_stock : (data.stock || 0);
    const stockInfo = document.createElement('small');
    stockInfo.className = 'text-success stock-info';
    stockInfo.innerHTML = `<i class="fas fa-info-circle"></i> Stock: ${stockValue} | Applied: ${rateSource} = â‚¹${selectedRate}`;
    
    const existingInfo = row.querySelector('.stock-info');
    if (existingInfo) existingInfo.remove();
    
    row.querySelector('.quantity').parentNode.appendChild(stockInfo);
    
    calculateEditRowTotal(row);
    
    // Auto-focus and validate
    setTimeout(() => {
        const quantityField = row.querySelector('.quantity');
        if (quantityField) {
            quantityField.focus();
            quantityField.select();
        }
        validateEditStockAndCalculate(rowIndex);
    }, 200);
}

function calculateEditRowTotal(row) {
    const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
    const rate = parseFloat(row.querySelector('.rate').value) || 0;
    const discount = parseFloat(row.querySelector('.discount').value) || 0;
    const igst = parseFloat(row.querySelector('.igst').value) || 0;
    
    const basePrice = quantity * rate;
    const discountedAmount = basePrice - discount; // Assuming flat discount
    const total = discountedAmount * (1 + (igst / 100));
    
    row.querySelector('.total').value = total.toFixed(2);
}

// Save edit sales invoice with comprehensive validation
document.getElementById('saveEditSalesInvoice').addEventListener('click', function() {
    // Check for stock errors before submission
    const stockErrors = document.querySelectorAll('#editProductsTable input[data-stock-error="true"]');
    if (stockErrors.length > 0) {
        // Count total errors and show detailed message
        const errorCount = stockErrors.length;
        const errorDetails = Array.from(stockErrors).map((input, index) => {
            const row = input.closest('tr');
            const productName = row.querySelector('.product-select option:checked')?.textContent || 'Unknown Product';
            const maxStock = input.getAttribute('data-max-stock') || '0';
            const currentQty = input.value || '0';
            return `${index + 1}. ${productName}: Entered ${currentQty}, Available ${maxStock}`;
        }).join('\n');
        
        alert(`Cannot save invoice! Found ${errorCount} stock validation error(s):\n\n${errorDetails}\n\nPlease correct these quantities before saving.`);
        
        // Focus on first error
        stockErrors[0].focus();
        stockErrors[0].select();
        return;
    }
    
    // Check if form is locked
    if (window.editFormLocked) {
        alert('Cannot save! Please fix stock quantity errors first.');
        return;
    }
    
    const form = document.getElementById('editSalesInvoiceForm');
    const formData = new FormData(form);
    
    // Collect products data
    const products = [];
    let hasValidProducts = false;
    
    document.querySelectorAll('#editProductRows .product-row').forEach(row => {
        const productSelect = row.querySelector('.product-select');
        const batchInput = row.querySelector('.batch-no');
        const quantityInput = row.querySelector('.quantity');
        
        if (productSelect && productSelect.value && 
            batchInput && batchInput.value && 
            quantityInput && quantityInput.value && 
            parseFloat(quantityInput.value) > 0) {
            
            products.push({
                productid: productSelect.value,
                batch_no: batchInput.value,
                expiry: row.querySelector('.expiry').value,
                mrp: row.querySelector('.mrp').value,
                sale_rate: row.querySelector('.rate').value,
                quantity: quantityInput.value,
                discount: row.querySelector('.discount').value,
                igst: row.querySelector('.igst').value,
                calculation_mode: 'flat',
                rate_applied: selectedEditCustomerRateType
            });
            hasValidProducts = true;
        }
    });
    
    if (!hasValidProducts) {
        alert('Please add at least one product with all required fields (Product, Batch, Quantity).');
        return;
    }
    
    formData.append('products_data', JSON.stringify(products));
    
    // Show loading state
    const saveBtn = this;
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;
    
    // Submit form
    fetch('{% url "edit_sales_invoice" pk=invoice.sales_invoice_no %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving the invoice.');
    })
    .finally(() => {
        // Restore button state
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
});

// Calculate totals for existing rows on load
document.querySelectorAll('#editProductRows .product-row').forEach(row => {
    calculateEditRowTotal(row);
});

// Setup enhanced quantity validation for edit modal
function setupEditQuantityValidation() {
    // Validate on paste
    document.addEventListener('paste', function(e) {
        if (e.target.classList.contains('quantity') && e.target.closest('#editProductsTable')) {
            setTimeout(() => {
                const value = e.target.value;
                if (!/^\d*\.?\d*$/.test(value)) {
                    e.target.value = value.replace(/[^0-9.]/g, '');
                }
                
                const row = e.target.closest('tr');
                const rowIndex = row.getAttribute('data-row-index');
                validateEditStockAndCalculate(rowIndex);
            }, 10);
        }
    });
}

// Initialize edit modal enhancements
document.addEventListener('DOMContentLoaded', function() {
    setupEditQuantityValidation();
});

// Enhanced keyboard shortcuts for edit modal
document.addEventListener('keydown', function(e) {
    // Only handle shortcuts when edit modal is open
    const editModal = document.getElementById('editSalesInvoiceModal');
    if (!editModal || editModal.style.display === 'none') {
        return;
    }
    
    // Ctrl + Enter to add new product row
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('addEditProductRow').click();
    }
    
    // F2 to open quick product search
    if (e.key === 'F2') {
        e.preventDefault();
        openEditQuickProductSearch();
    }
    
    // Alt + W for batch selection
    if (e.altKey && e.key.toLowerCase() === 'w') {
        e.preventDefault();
        const focusedElement = document.activeElement;
        
        if (focusedElement && focusedElement.classList.contains('batch-no')) {
            const row = focusedElement.closest('tr');
            const productSelect = row.querySelector('.product-select');
            const rowIndex = row.getAttribute('data-row-index');
            
            if (productSelect && productSelect.value) {
                showEditBatchSelectionDialog(productSelect.value, rowIndex);
            } else {
                alert('Please select a product first!');
            }
        }
    }
});

// Load product details for edit modal
function loadEditProductDetails(productSelect, rowIndex) {
    if (!productSelect.value) return;
    
    console.log(`ðŸ”„ Loading edit product details for row ${rowIndex}, customer rate type: ${selectedEditCustomerRateType}`);
    
    fetch(`/api/product-batch-selector/?product_id=${productSelect.value}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.batches.length > 0) {
                const row = document.getElementById(`editProductRow_${rowIndex}`);
                const firstBatch = data.batches[0];
                
                // Auto-fill fields
                row.querySelector('.batch-no').value = firstBatch.batch_no;
                row.querySelector('.expiry').value = firstBatch.expiry;
                row.querySelector('.mrp').value = firstBatch.mrp;
                
                // Set rate based on customer type with proper fallback
                let selectedRate = firstBatch.mrp; // Default fallback
                let rateSource = 'MRP (Fallback)';
                
                if (firstBatch.rates) {
                    if (selectedEditCustomerRateType === 'A' && firstBatch.rates.rate_A > 0) {
                        selectedRate = firstBatch.rates.rate_A;
                        rateSource = 'Rate A';
                    } else if (selectedEditCustomerRateType === 'B' && firstBatch.rates.rate_B > 0) {
                        selectedRate = firstBatch.rates.rate_B;
                        rateSource = 'Rate B';
                    } else if (selectedEditCustomerRateType === 'C' && firstBatch.rates.rate_C > 0) {
                        selectedRate = firstBatch.rates.rate_C;
                        rateSource = 'Rate C';
                    }
                }
                
                console.log(`ðŸ’° Edit Rate Applied: ${rateSource} = â‚¹${selectedRate}`);
                
                row.querySelector('.rate').value = selectedRate;
                row.querySelector('.quantity').value = '1';
                row.querySelector('.discount').value = '0';
                row.querySelector('.igst').value = '12';
                
                // Show enhanced stock info with rate source
                const stockInfo = document.createElement('small');
                stockInfo.className = 'text-success stock-info';
                stockInfo.innerHTML = `<i class="fas fa-info-circle"></i> Stock: ${firstBatch.stock} | Applied: ${rateSource} = â‚¹${selectedRate}`;
                
                const existingInfo = row.querySelector('.stock-info');
                if (existingInfo) existingInfo.remove();
                
                row.querySelector('.quantity').parentNode.appendChild(stockInfo);
                
                calculateEditRowTotal(row);
                
                // Focus on quantity field
                setTimeout(() => {
                    const quantityField = row.querySelector('.quantity');
                    if (quantityField) {
                        quantityField.focus();
                        quantityField.select();
                    }
                    validateEditStockAndCalculate(rowIndex);
                }, 200);
            }
        })
        .catch(error => {
            console.error('Error fetching product batches:', error);
        });
}

// Comprehensive stock validation for edit modal - exact copy from combined invoice
function validateEditStockAndCalculate(index) {
    const row = document.getElementById(`editProductRow_${index}`);
    if (!row) return;
    
    const quantityInput = row.querySelector('.quantity');
    const stockError = row.querySelector('.stock-error');
    const stockInfo = row.querySelector('.stock-info');
    const quantity = parseFloat(quantityInput.value) || 0;
    
    console.log(`ðŸ” Edit Stock Validation - Row ${index}: Quantity=${quantity}`);
    
    // Get available stock from stock info - works for all batches
    let availableStock = 0;
    if (stockInfo && stockInfo.textContent) {
        const stockMatch = stockInfo.textContent.match(/Stock: (\d+(?:\.\d+)?)/i);
        if (stockMatch) {
            availableStock = parseFloat(stockMatch[1]);
        }
    }
    
    console.log(`Available stock: ${availableStock}`);
    
    // Validate stock for ANY batch - not just first one
    if (availableStock >= 0 && quantity > availableStock) {
        // Show error message
        const errorMsg = availableStock === 0 
            ? 'Out of stock! This batch is not available' 
            : `Insufficient stock! Available: ${availableStock} units`;
        
        console.log(`âŒ Edit Stock Error - Row ${index}: ${errorMsg}`);
        
        stockError.textContent = errorMsg;
        stockError.style.display = 'block';
        stockError.style.color = '#dc3545';
        stockError.style.fontWeight = 'bold';
        stockError.style.fontSize = '0.75rem';
        stockError.style.marginTop = '4px';
        
        // Style the input with error state
        quantityInput.style.borderColor = '#dc3545';
        quantityInput.style.backgroundColor = '#f8d7da';
        quantityInput.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';
        
        // Mark input as having stock error
        quantityInput.setAttribute('data-stock-error', 'true');
        quantityInput.setAttribute('data-max-stock', availableStock);
        
        // Lock the input and prevent further changes
        quantityInput.focus();
        quantityInput.select();
        
        // Disable form submission and other inputs
        lockEditFormInputs(true);
        
        // Add visual indicator to the row
        row.classList.add('stock-error-row');
        
        return false; // Indicate validation failed
    } else {
        console.log(`âœ… Edit Stock Valid - Row ${index}: Quantity within limits`);
        
        // Clear error state
        stockError.style.display = 'none';
        quantityInput.style.borderColor = '';
        quantityInput.style.backgroundColor = '';
        quantityInput.style.boxShadow = '';
        quantityInput.removeAttribute('data-stock-error');
        quantityInput.removeAttribute('data-max-stock');
        
        // Remove error styling from row
        row.classList.remove('stock-error-row');
        
        // Unlock form if no other stock errors exist
        if (!document.querySelector('#editProductsTable input[data-stock-error="true"]')) {
            lockEditFormInputs(false);
        }
    }
    
    calculateEditRowTotal(row);
    return true; // Indicate validation passed
}

// Enhanced function to lock/unlock edit form inputs
function lockEditFormInputs(lock) {
    const form = document.getElementById('editSalesInvoiceForm');
    const inputs = form.querySelectorAll('input:not(.quantity[data-stock-error="true"]), select, button[type="button"]:not(.batch-modal-close)');
    
    inputs.forEach(input => {
        if (lock) {
            input.disabled = true;
            input.style.opacity = '0.5';
            input.style.pointerEvents = 'none';
            input.setAttribute('data-locked', 'true');
        } else {
            input.disabled = false;
            input.style.opacity = '1';
            input.style.pointerEvents = 'auto';
            input.removeAttribute('data-locked');
        }
    });
    
    // Store lock state globally
    window.editFormLocked = lock;
    
    // Enhanced overlay with better styling
    let overlay = document.getElementById('editStockErrorOverlay');
    if (lock && !overlay) {
        overlay = document.createElement('div');
        overlay.id = 'editStockErrorOverlay';
        overlay.innerHTML = `
            <div style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
                        background: linear-gradient(135deg, #dc3545, #c82333); color: white; 
                        padding: 20px 30px; border-radius: 12px; z-index: 10002; 
                        font-weight: bold; box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
                        border: 2px solid rgba(255, 255, 255, 0.2);">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 1.2rem;"></i>
                    <div>
                        <div style="font-size: 1.1rem; margin-bottom: 5px;">Stock Validation Error</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Correct the quantity to continue</div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
        
        // Auto-hide overlay after 5 seconds
        setTimeout(() => {
            if (overlay && overlay.parentNode) {
                overlay.style.opacity = '0';
                overlay.style.transform = 'translateX(-50%) translateY(-20px)';
                setTimeout(() => overlay.remove(), 300);
            }
        }, 5000);
    } else if (!lock && overlay) {
        overlay.style.opacity = '0';
        overlay.style.transform = 'translateX(-50%) translateY(-20px)';
        setTimeout(() => overlay.remove(), 300);
    }
    
    // Update save button state
    const saveBtn = document.getElementById('saveEditSalesInvoice');
    if (saveBtn) {
        if (lock) {
            saveBtn.innerHTML = '<i class="fas fa-ban"></i> Fix Stock Errors First';
            saveBtn.classList.add('btn-danger');
            saveBtn.classList.remove('btn-primary');
        } else {
            saveBtn.innerHTML = 'Save Changes';
            saveBtn.classList.add('btn-primary');
            saveBtn.classList.remove('btn-danger');
        }
    }
}

// Quick product search for edit modal
function openEditQuickProductSearch() {
    const existingModal = document.getElementById('editQuickProductModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Create modal inside the edit modal to ensure proper z-index
    const editModal = document.getElementById('editSalesInvoiceModal');
    const modalHTML = `
        <div id="editQuickProductModal" class="quick-search-overlay" style="position: absolute; z-index: 10000;">
            <div class="quick-search-content">
                <div class="quick-search-header">
                    <h4>ðŸ” Quick Product Search</h4>
                    <small>Type product name and press Enter</small>
                </div>
                <div class="quick-search-input">
                    <input type="text" id="editQuickProductInput" placeholder="Type product name...">
                </div>
                <div class="quick-search-results" id="editQuickResults"></div>
                <div class="quick-search-footer">
                    <small>â†‘â†“: Navigate | Enter: Select | Esc: Close</small>
                </div>
            </div>
        </div>
    `;
    
    editModal.insertAdjacentHTML('beforeend', modalHTML);
    
    setTimeout(() => {
        const input = document.getElementById('editQuickProductInput');
        input.focus();
        
        // Add input event listener
        input.addEventListener('input', function(e) {
            editQuickSearchProducts(e);
        });
        
        input.addEventListener('keydown', function(e) {
            const resultsDiv = document.getElementById('editQuickResults');
            
            switch(e.key) {
                case 'Escape':
                    e.preventDefault();
                    closeEditQuickSearch();
                    break;
                    
                case 'ArrowDown':
                    e.preventDefault();
                    navigateEditResults(1);
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    navigateEditResults(-1);
                    break;
                    
                case 'Enter':
                    e.preventDefault();
                    const selected = resultsDiv.querySelector('.selected') || resultsDiv.querySelector('.quick-result-item');
                    if (selected) {
                        const productId = selected.getAttribute('data-product-id');
                        const productName = selected.querySelector('.product-name').textContent;
                        const productCompany = selected.querySelector('.product-company').textContent;
                        
                        editQuickSelectProduct(productId, productName, productCompany);
                    }
                    break;
            }
        });
    }, 100);
}

function editQuickSearchProducts(event) {
    const originalSearchTerm = event.target.value;
    const searchTerm = originalSearchTerm.toLowerCase();
    const resultsDiv = document.getElementById('editQuickResults');
    
    if (originalSearchTerm.length < 2) {
        resultsDiv.innerHTML = '<div class="quick-hint">Type at least 2 characters...</div>';
        return;
    }
    
    const products = [{% for product in products %}{
        id: {{ product.productid }},
        name: '{{ product.product_name|escapejs }}',
        company: '{{ product.product_company|escapejs }}'
    },{% endfor %}];
    
    // Filter products that START with the search term (first 2+ letters)
    const filtered = products.filter(p => {
        // Primary filter: starts with search term (case-sensitive first, then case-insensitive)
        const exactStartsName = p.name.startsWith(originalSearchTerm);
        const exactStartsCompany = p.company.startsWith(originalSearchTerm);
        const startsName = p.name.toLowerCase().startsWith(searchTerm);
        const startsCompany = p.company.toLowerCase().startsWith(searchTerm);
        
        return exactStartsName || exactStartsCompany || startsName || startsCompany;
    }).sort((a, b) => {
        // Priority scoring for "starts with" matches
        let aScore = 0;
        let bScore = 0;
        
        // Exact case "starts with" gets highest priority (100 points)
        if (a.name.startsWith(originalSearchTerm)) aScore += 100;
        if (a.company.startsWith(originalSearchTerm)) aScore += 90;
        if (b.name.startsWith(originalSearchTerm)) bScore += 100;
        if (b.company.startsWith(originalSearchTerm)) bScore += 90;
        
        // Case-insensitive "starts with" gets medium priority (50 points)
        if (a.name.toLowerCase().startsWith(searchTerm)) aScore += 50;
        if (a.company.toLowerCase().startsWith(searchTerm)) aScore += 40;
        if (b.name.toLowerCase().startsWith(searchTerm)) bScore += 50;
        if (b.company.toLowerCase().startsWith(searchTerm)) bScore += 40;
        
        // Sort by score (higher score first)
        if (aScore !== bScore) {
            return bScore - aScore;
        }
        
        // If scores are equal, sort alphabetically
        return a.name.localeCompare(b.name);
    });
    
    if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">No products starting with "' + originalSearchTerm + '" found</div>';
        return;
    }
    
    resultsDiv.innerHTML = filtered.map((product, index) => `
        <div class="quick-result-item ${index === 0 ? 'selected' : ''}" 
             data-product-id="${product.id}"
             onclick="editQuickSelectProduct('${product.id}', '${product.name}', '${product.company}')">
            <div class="product-name">${product.name}</div>
            <div class="product-company">${product.company}</div>
        </div>
    `).join('');
}

function navigateEditResults(direction) {
    const items = document.querySelectorAll('#editQuickResults .quick-result-item');
    if (items.length === 0) return;
    
    const current = document.querySelector('#editQuickResults .quick-result-item.selected');
    let newIndex = 0;
    
    if (current) {
        const currentIndex = Array.from(items).indexOf(current);
        newIndex = currentIndex + direction;
        
        // Wrap around navigation
        if (newIndex < 0) newIndex = items.length - 1;
        else if (newIndex >= items.length) newIndex = 0;
        
        current.classList.remove('selected');
    } else {
        // If no selection, select first or last based on direction
        newIndex = direction > 0 ? 0 : items.length - 1;
    }
    
    items[newIndex].classList.add('selected');
    items[newIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function editQuickSelectProduct(productId, productName, productCompany) {
    const rows = document.querySelectorAll('#editProductRows tr.product-row');
    let targetRow = null;
    
    // Find first empty row (no product selected)
    for (let row of rows) {
        const productSelect = row.querySelector('.product-select');
        if (productSelect && !productSelect.value) {
            targetRow = row;
            break;
        }
    }
    
    // If no empty row found, add new row
    if (!targetRow) {
        document.getElementById('addEditProductRow').click();
        setTimeout(() => {
            const newRows = document.querySelectorAll('#editProductRows tr.product-row');
            targetRow = newRows[newRows.length - 1];
            fillEditProductInRow(targetRow, productId);
        }, 200);
    } else {
        fillEditProductInRow(targetRow, productId);
    }
    
    closeEditQuickSearch();
}

function fillEditProductInRow(row, productId) {
    const productSelect = row.querySelector('.product-select');
    if (productSelect) {
        // Set the product value
        productSelect.value = productId;
        
        // Trigger change event to load product details
        const rowIndex = row.getAttribute('data-row-index');
        if (rowIndex) {
            loadEditProductDetails(productSelect, rowIndex);
        }
        
        // Focus on batch field after product details are loaded
        setTimeout(() => {
            const batchField = row.querySelector('.batch-no');
            if (batchField) {
                batchField.focus();
                batchField.select();
                
                // Add visual indicator
                batchField.style.backgroundColor = '#d4edda';
                batchField.style.borderColor = '#28a745';
                setTimeout(() => {
                    batchField.style.backgroundColor = '';
                    batchField.style.borderColor = '';
                }, 2000);
            }
        }, 600);
    }
}

function closeEditQuickSearch() {
    const modal = document.getElementById('editQuickProductModal');
    if (modal) {
        modal.remove();
    }
    
    // Return focus to edit modal
    const editModal = document.getElementById('editSalesInvoiceModal');
    if (editModal) {
        editModal.focus();
    }
}

// Batch selection for edit modal
function showEditBatchSelectionDialog(productId, rowIndex) {
    fetch(`/api/product-batch-selector/?product_id=${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.batches.length > 0) {
                createEditBatchSelectionModal(data.batches, rowIndex);
            } else {
                alert('No batches found for this product.');
            }
        })
        .catch(error => {
            console.error('Error fetching batches:', error);
            alert('Error loading batch information.');
        });
}

function createEditBatchSelectionModal(batches, rowIndex) {
    const existingModal = document.getElementById('editBatchSelectionModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Create modal inside the edit modal
    const editModal = document.getElementById('editSalesInvoiceModal');
    const modalHTML = `
        <div id="editBatchSelectionModal" class="batch-modal-overlay" style="position: absolute; z-index: 10001;">
            <div class="batch-modal-content">
                <div class="batch-modal-header">
                    <h3>Select Batch</h3>
                    <button type="button" class="batch-modal-close" onclick="closeEditBatchModal()">&times;</button>
                </div>
                <div class="batch-modal-body">
                    <div class="batch-search">
                        <input type="text" id="editBatchSearch" placeholder="Search batch...">
                    </div>
                    <div class="batch-list" id="editBatchList" tabindex="0">
                        ${batches.map((batch, index) => `
                            <div class="batch-item ${index === 0 ? 'batch-selected' : ''} ${batch.is_available ? '' : 'batch-unavailable'}" 
                                 data-batch-index="${index}" data-row-index="${rowIndex}" data-batch-data='${JSON.stringify(batch)}'>
                                <div class="batch-info">
                                    <div class="batch-no"><strong>${batch.batch_no}</strong></div>
                                    <div class="batch-details">
                                        <span class="batch-expiry">Exp: ${batch.expiry}</span>
                                        <span class="batch-stock">Stock: ${batch.stock}</span>
                                        <span class="batch-mrp">MRP: â‚¹${batch.mrp}</span>
                                    </div>
                                    <div class="batch-rates">
                                        <span>A: â‚¹${batch.rates ? batch.rates.rate_A : 0}</span>
                                        <span>B: â‚¹${batch.rates ? batch.rates.rate_B : 0}</span>
                                        <span>C: â‚¹${batch.rates ? batch.rates.rate_C : 0}</span>
                                    </div>
                                </div>
                                <div class="batch-status">
                                    ${batch.is_available ? '<span class="status-available">Available</span>' : '<span class="status-unavailable">Out of Stock</span>'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="batch-modal-footer">
                    <div class="batch-shortcuts">
                        <small>â†‘â†“: Navigate | Enter: Select | Esc: Close</small>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="closeEditBatchModal()">Cancel</button>
                </div>
            </div>
        </div>
    `;
    
    editModal.insertAdjacentHTML('beforeend', modalHTML);
    
    setTimeout(() => {
        initializeEditBatchSelection();
    }, 50);
}

function initializeEditBatchSelection() {
    const modal = document.getElementById('editBatchSelectionModal');
    const searchInput = document.getElementById('editBatchSearch');
    const batchList = document.getElementById('editBatchList');
    
    if (!modal || !searchInput || !batchList) return;
    
    searchInput.focus();
    
    function handleEditModalKeydown(e) {
        e.stopPropagation();
        
        const visibleItems = batchList.querySelectorAll('.batch-item:not([style*="display: none"])');
        let selectedIndex = Array.from(visibleItems).findIndex(item => item.classList.contains('batch-selected'));
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                if (visibleItems.length > 0) {
                    visibleItems.forEach(item => item.classList.remove('batch-selected'));
                    selectedIndex = selectedIndex < visibleItems.length - 1 ? selectedIndex + 1 : 0;
                    visibleItems[selectedIndex].classList.add('batch-selected');
                    visibleItems[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
                break;
                
            case 'ArrowUp':
                e.preventDefault();
                if (visibleItems.length > 0) {
                    visibleItems.forEach(item => item.classList.remove('batch-selected'));
                    selectedIndex = selectedIndex > 0 ? selectedIndex - 1 : visibleItems.length - 1;
                    visibleItems[selectedIndex].classList.add('batch-selected');
                    visibleItems[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
                break;
                
            case 'Enter':
                e.preventDefault();
                const selectedItem = batchList.querySelector('.batch-item.batch-selected');
                if (selectedItem) {
                    const batchData = JSON.parse(selectedItem.getAttribute('data-batch-data'));
                    const rowIndex = selectedItem.getAttribute('data-row-index');
                    selectEditBatch(batchData.batch_no, rowIndex, batchData);
                }
                break;
                
            case 'Escape':
                e.preventDefault();
                closeEditBatchModal();
                break;
        }
    }
    
    modal.addEventListener('keydown', handleEditModalKeydown);
    
    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const batchItems = batchList.querySelectorAll('.batch-item');
        
        batchItems.forEach(item => item.classList.remove('batch-selected'));
        
        let firstVisible = null;
        batchItems.forEach(item => {
            const batchNo = item.querySelector('.batch-no').textContent.toLowerCase();
            const batchDetails = item.querySelector('.batch-details').textContent.toLowerCase();
            
            if (batchNo.includes(searchTerm) || batchDetails.includes(searchTerm)) {
                item.style.display = 'block';
                if (!firstVisible) firstVisible = item;
            } else {
                item.style.display = 'none';
            }
        });
        
        if (firstVisible) {
            firstVisible.classList.add('batch-selected');
        }
    });
    
    const batchItems = batchList.querySelectorAll('.batch-item');
    batchItems.forEach(item => {
        item.addEventListener('click', function() {
            const batchData = JSON.parse(this.getAttribute('data-batch-data'));
            const rowIndex = this.getAttribute('data-row-index');
            selectEditBatch(batchData.batch_no, rowIndex, batchData);
        });
    });
}

function selectEditBatch(batchNo, rowIndex, batchData) {
    const row = document.getElementById(`editProductRow_${rowIndex}`);
    if (row) {
        console.log(`ðŸŽ¯ Edit Batch Selected: ${batchNo}, Customer Rate Type: ${selectedEditCustomerRateType}`);
        
        row.querySelector('.batch-no').value = batchNo;
        row.querySelector('.expiry').value = batchData.expiry;
        row.querySelector('.mrp').value = batchData.mrp;
        
        // Apply customer-specific rate with proper fallback
        let selectedRate = batchData.mrp; // Default fallback
        let rateSource = 'MRP (Fallback)';
        
        if (batchData.rates) {
            if (selectedEditCustomerRateType === 'A' && batchData.rates.rate_A > 0) {
                selectedRate = batchData.rates.rate_A;
                rateSource = 'Rate A';
            } else if (selectedEditCustomerRateType === 'B' && batchData.rates.rate_B > 0) {
                selectedRate = batchData.rates.rate_B;
                rateSource = 'Rate B';
            } else if (selectedEditCustomerRateType === 'C' && batchData.rates.rate_C > 0) {
                selectedRate = batchData.rates.rate_C;
                rateSource = 'Rate C';
            }
        }
        
        console.log(`ðŸ’° Edit Batch Rate Applied: ${rateSource} = â‚¹${selectedRate}`);
        
        row.querySelector('.rate').value = selectedRate;
        row.querySelector('.quantity').value = '1';
        row.querySelector('.discount').value = '0';
        row.querySelector('.igst').value = '12';
        
        calculateEditRowTotal(row);
        
        setTimeout(() => {
            const quantityField = row.querySelector('.quantity');
            if (quantityField) {
                quantityField.focus();
                quantityField.select();
            }
            validateEditStockAndCalculate(rowIndex);
        }, 200);
        
        // Show enhanced stock info with rate source
        const stockInfo = document.createElement('small');
        stockInfo.className = 'text-success stock-info';
        stockInfo.innerHTML = `<i class="fas fa-info-circle"></i> Stock: ${batchData.stock} | Applied: ${rateSource} = â‚¹${selectedRate}`;
        
        const existingInfo = row.querySelector('.stock-info');
        if (existingInfo) existingInfo.remove();
        
        row.querySelector('.quantity').parentNode.appendChild(stockInfo);
    }
    
    closeEditBatchModal();
}

function closeEditBatchModal() {
    const modal = document.getElementById('editBatchSelectionModal');
    if (modal) {
        modal.remove();
    }
    
    // Return focus to edit modal
    const editModal = document.getElementById('editSalesInvoiceModal');
    if (editModal) {
        editModal.focus();
    }
}

// Customer rate functions for edit modal
function fetchEditCustomerRateInfo(customerId) {
    if (!customerId) {
        hideEditCustomerRateInfo();
        return;
    }
    
    fetch(`/api/customer-rate-info/?customer_id=${customerId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showEditCustomerRateInfo(data.customer_type, data.rate_type);
            } else {
                hideEditCustomerRateInfo();
            }
        })
        .catch(error => {
            console.error('Error fetching edit customer rate:', error);
            hideEditCustomerRateInfo();
        });
}

function showEditCustomerRateInfo(customerType, rateType) {
    const rateInfo = document.getElementById('editCustomerRateInfo');
    const rateText = rateInfo.querySelector('.customer-rate-text');
    
    // Store customer rate type globally (extract A, B, C from customer type)
    if (customerType.includes('A') || customerType === 'Type-A') {
        selectedEditCustomerRateType = 'A';
    } else if (customerType.includes('B') || customerType === 'Type-B') {
        selectedEditCustomerRateType = 'B';
    } else if (customerType.includes('C') || customerType === 'Type-C') {
        selectedEditCustomerRateType = 'C';
    } else {
        selectedEditCustomerRateType = 'A'; // Default
    }
    
    rateText.innerHTML = `<i class="fas fa-user"></i> Customer Type: <strong>${customerType}</strong> | Rate: <strong>Rate ${selectedEditCustomerRateType}</strong>`;
    rateInfo.style.display = 'block';
    
    console.log(`âœ… Edit Customer Rate Type Set: ${selectedEditCustomerRateType}`);
}

function hideEditCustomerRateInfo() {
    const rateInfo = document.getElementById('editCustomerRateInfo');
    rateInfo.style.display = 'none';
    selectedEditCustomerRateType = 'A'; // Reset to default
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+E for edit
    if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        document.getElementById('editSalesInvoiceModal').style.display = 'block';
        setTimeout(() => {
            const invoiceDateField = document.getElementById('edit_sales_invoice_date');
            if (invoiceDateField) {
                invoiceDateField.focus();
                invoiceDateField.select();
            }
        }, 300);
    }
    
    // Ctrl+P for print receipt
    if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        const printReceiptUrl = "{% url 'print_receipt' pk=invoice.sales_invoice_no %}";
        window.open(printReceiptUrl, '_blank');
    }
});
</script>
<script>
// Delete Sale Dialog
let deleteSaleId = null;

function confirmDeleteSale(saleId, productName) {
    deleteSaleId = saleId;
    const existingDialog = document.getElementById('deleteSaleDialog');
    if (existingDialog) existingDialog.remove();
    
    const dialogHTML = `
        <div id="deleteSaleDialog" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10001; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 450px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); text-align: center;">
                <div style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"><i class="fas fa-exclamation-triangle"></i></div>
                <h3 style="color: #2c3e50; margin-bottom: 1rem;">Delete Product?</h3>
                <p style="color: #555; margin-bottom: 1.5rem;">Are you sure you want to delete <strong style="color: #e74c3c;">${productName}</strong>?</p>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button onclick="executeSaleDelete()" style="padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white;"><i class="fas fa-check"></i> Yes, Delete (Enter)</button>
                    <button onclick="closeDeleteSaleDialog()" style="padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: linear-gradient(135deg, #95a5a6, #7f8c8d); color: white;"><i class="fas fa-times"></i> Cancel (Esc)</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', dialogHTML);
    
    document.addEventListener('keydown', function handleKey(e) {
        if (e.key === 'Enter') {
            executeSaleDelete();
            document.removeEventListener('keydown', handleKey);
        } else if (e.key === 'Escape') {
            closeDeleteSaleDialog();
            document.removeEventListener('keydown', handleKey);
        }
    });
}

function executeSaleDelete() {
    if (!deleteSaleId) return;
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/sales/{{ invoice.sales_invoice_no }}/delete-sale/${deleteSaleId}/`;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
    form.appendChild(csrfInput);
    document.body.appendChild(form);
    form.submit();
}

function closeDeleteSaleDialog() {
    const dialog = document.getElementById('deleteSaleDialog');
    if (dialog) dialog.remove();
    deleteSaleId = null;
}
</script>
<div style="position: fixed; bottom: 0; left: 0; right: 0; background: #1f2937; color: #d1d5db; padding: 10px 20px; font-size: 0.8rem; display: flex; justify-content: center; gap: 30px; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
    <div style="display: flex; align-items: center; gap: 5px;">
        <span style="background: #374151; padding: 2px 6px; border-radius: 3px; font-weight: 600; font-size: 0.7rem;">Ctrl+E</span>
        <span>Edit Invoice</span>
    </div>
    <div style="display: flex; align-items: center; gap: 5px;">
        <span style="background: #374151; padding: 2px 6px; border-radius: 3px; font-weight: 600; font-size: 0.7rem;">Ctrl+P</span>
        <span>Print receipt</span>
    </div>
    <!-- <div style="display: flex; align-items: center; gap: 5px;">
        <span style="background: #374151; padding: 2px 6px; border-radius: 3px; font-weight: 600; font-size: 0.7rem;">Alt+W</span>
        <span>Batch Selector</span>
    </div> -->
    <!-- <div style="display: flex; align-items: center; gap: 5px;">
        <span style="background: #374151; padding: 2px 6px; border-radius: 3px; font-weight: 600; font-size: 0.7rem;">Ctrl+S</span>
        <span>Save Invoice</span>
    </div> -->
    <!-- <div style="display: flex; align-items: center; gap: 5px;">
        <span style="background: #374151; padding: 2px 6px; border-radius: 3px; font-weight: 600; font-size: 0.7rem;">Ctrl+D</span>
        <span>Duplicate Row</span>
    </div> -->
</div>
{% endblock %}
