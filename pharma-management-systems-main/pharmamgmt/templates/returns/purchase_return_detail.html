{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/purchase_return_detail.css' %}">
{% endblock %}

{% block content %}
<div class="purchase-return-detail-container">
    <!-- Header Section -->
    <div class="purchase-return-detail-header">
        <div class="header-content">
            <h4 class="page-title">
                <i class="fas fa-undo text-warning"></i> Purchase Return Details
            </h4>
            <div class="header-actions">
                <button type="button" class="btn btn-warning" onclick="console.log('Edit button clicked'); openEditPurchaseReturnModal();">
                    <i class="fas fa-edit"></i> Edit Return
                </button>
                <a href="{% url 'purchase_return_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to List
                </a>
            </div>
        </div>
    </div>

    <!-- Return Invoice Info -->
    <div class="return-info-section">
        <div class="return-info-card">
            <div class="return-info-header">
                <h5><i class="fas fa-file-invoice text-warning"></i> Return Invoice Information</h5>
            </div>
            <div class="return-info-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="info-item">
                            <label>Return ID:</label>
                            <span class="return-id">{{ return_invoice.returninvoiceid }}</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-item">
                            <label>Return Date:</label>
                            <span>{{ return_invoice.returninvoice_date|date:"d-m-Y" }}</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-item">
                            <label>Supplier:</label>
                            <span>{{ return_invoice.returnsupplierid.supplier_name }}</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-item">
                            <label>Status:</label>
                            <span class="badge {% if return_invoice.balance_due > 0 %}bg-warning{% else %}bg-success{% endif %}">
                                {% if return_invoice.balance_due > 0 %}Pending{% else %}Completed{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Return Items Section -->
    <div class="return-items-section">
        <div class="return-items-card">
            <div class="return-items-header">
                <h5><i class="fas fa-list text-primary"></i> Return Items</h5>
                <span class="items-count">{{ return_items.count }} item{{ return_items.count|pluralize }}</span>
            </div>
            <div class="return-items-body">
                {% if return_items %}
                <div class="table-responsive">
                    <table class="table table-hover return-items-table">
                        <thead class="table-dark">
                            <tr>
                                <th>Product</th>
                                <th>Batch No</th>
                                <th>Expiry</th>
                                <th>Quantity</th>
                                <th>Rate</th>
                                <th>Total</th>
                                <th>Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in return_items %}
                            <tr>
                                <td>
                                    <div class="product-info">
                                        <strong>{{ item.returnproductid.product_name }}</strong>
                                        <small class="text-muted d-block">{{ item.returnproductid.product_company }}</small>
                                    </div>
                                </td>
                                <td>{{ item.returnproduct_batch_no }}</td>
                                <td>{{ item.returnproduct_expiry|date:"m-Y" }}</td>
                                <td class="quantity-cell">{{ item.returnproduct_quantity }}</td>
                                <td class="amount-cell">‚Çπ{{ item.returnproduct_purchase_rate|floatformat:2 }}</td>
                                <td class="amount-cell">‚Çπ{{ item.returntotal_amount|floatformat:2 }}</td>
                                <td>
                                    {% if item.return_reason %}
                                        <span class="reason-text">{{ item.return_reason|truncatechars:30 }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            onclick="showDeleteDialog('{{ item.returnpurchaseid }}', '{{ item.returnproductid.product_name|escapejs }}', '{{ item.returnproduct_batch_no }}')" 
                                            title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-items-state">
                    <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                    <h6>No items added yet</h6>
                    <p class="text-muted">This return has no items.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Summary Section -->
    <div class="return-summary-section">
        <div class="return-summary-card">
            <div class="return-summary-header">
                <h5><i class="fas fa-calculator text-success"></i> Return Summary</h5>
            </div>
            <div class="return-summary-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="summary-details">
                            <div class="summary-row">
                                <span class="summary-label">Items Total:</span>
                                <span class="summary-value">‚Çπ{{ items_total|floatformat:2 }}</span>
                            </div>
                            <div class="summary-row">
                                <span class="summary-label">Return Charges:</span>
                                <span class="summary-value">‚Çπ{{ return_invoice.return_charges|floatformat:2 }}</span>
                            </div>
                            <div class="summary-row total-row">
                                <span class="summary-label">Total Amount:</span>
                                <span class="summary-value">‚Çπ{{ return_invoice.returninvoice_total|floatformat:2 }}</span>
                            </div>
                            <div class="summary-row">
                                <span class="summary-label">Amount Received:</span>
                                <span class="summary-value">‚Çπ{{ return_invoice.returninvoice_paid|floatformat:2 }}</span>
                            </div>
                            <div class="summary-row balance-row">
                                <span class="summary-label">Balance Due:</span>
                                <span class="summary-value {% if return_invoice.balance_due > 0 %}text-danger{% else %}text-success{% endif %}">
                                    ‚Çπ{{ return_invoice.balance_due|floatformat:2 }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="summary-actions">
                            <button class="btn btn-primary btn-block mb-2">
                                <i class="fas fa-print"></i> Print Return
                            </button>
                            <button class="btn btn-info btn-block mb-2">
                                <i class="fas fa-download"></i> Download PDF
                            </button>
                            {% if request.user.user_type == 'admin' %}
                            <a href="{% url 'delete_purchase_return' pk=return_invoice.returninvoiceid %}" 
                               class="btn btn-danger btn-block">
                                <i class="fas fa-trash"></i> Delete Return
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Purchase Return Modal -->
<div id="editPurchaseReturnModal" class="modal-overlay" style="display: none;">
    <div class="modal-content-large">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Edit Purchase Return</h3>
            <button type="button" class="modal-close" onclick="closeEditPurchaseReturnModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editPurchaseReturnForm">
                {% csrf_token %}
                <input type="hidden" id="editReturnId" value="{{ return_invoice.returninvoiceid }}">
                
                <div class="edit-return-header-row">
                    <div class="edit-return-field">
                        <label>Return ID</label>
                        <input type="text" class="form-control" value="{{ return_invoice.returninvoiceid }}" readonly>
                    </div>
                    <div class="edit-return-field">
                        <label>Supplier*</label>
                        <select id="editSupplierId" class="form-control" required>
                            {% for supplier in suppliers %}
                            <option value="{{ supplier.supplierid }}" {% if supplier.supplierid == return_invoice.returnsupplierid.supplierid %}selected{% endif %}>{{ supplier.supplier_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="edit-return-field">
                        <label>Return Date*</label>
                        <input type="date" id="editReturnDate" class="form-control" value="{{ return_invoice.returninvoice_date|date:'Y-m-d' }}" required>
                    </div>
                    <div class="edit-return-field">
                        <label>Return Charges</label>
                        <input type="number" id="editReturnCharges" class="form-control" value="{{ return_invoice.return_charges }}" step="0.01" min="0" onchange="calculateEditReturnTotal()">
                    </div>
                </div>
                
                <div class="products-section">
                    <div class="products-header">
                        <h5>Return Products</h5>
                        <div class="product-actions">
                            <button type="button" class="btn btn-sm btn-primary" onclick="openQuickProductSearchForEdit()">
                                <i class="fas fa-search"></i> Ctrl+F2: Quick Search
                            </button>
                            <small class="text-muted">Alt+W: Select Batch</small>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Batch</th>
                                    <th>Expiry</th>
                                    <th>MRP</th>
                                    <th>Rate</th>
                                    <th>Qty</th>
                                    <th>Scheme</th>
                                    <th>Charges</th>
                                    <th>Reason</th>
                                    <th>Total</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="editReturnProductRows">
                                {% for item in return_items %}
                                <tr id="editReturnRow_{{ forloop.counter0 }}" data-item-id="{{ item.returnpurchaseid }}">
                                    <td>
                                        <select class="form-control form-control-sm product-select" onchange="loadEditReturnProductInfo({{ forloop.counter0 }}, this.value)" required>
                                            <option value="">Select Product</option>
                                            {% for product in products %}
                                            <option value="{{ product.productid }}" {% if product.productid == item.returnproductid.productid %}selected{% endif %}>{{ product.product_name }} - {{ product.product_company }}</option>
                                            {% endfor %}
                                        </select>
                                        <input type="hidden" class="product-id" value="{{ item.returnproductid.productid }}">
                                    </td>
                                    <td><input type="text" class="form-control form-control-sm batch-no" value="{{ item.returnproduct_batch_no }}" required></td>
                                    <td><input type="text" class="form-control form-control-sm expiry" value="{{ item.returnproduct_expiry|date:'m-Y' }}" placeholder="MM-YYYY" maxlength="7" required></td>
                                    <td><input type="number" class="form-control form-control-sm mrp" value="{{ item.returnproduct_MRP }}" step="0.01" required></td>
                                    <td><input type="number" class="form-control form-control-sm return-rate" value="{{ item.returnproduct_purchase_rate }}" step="0.01" onchange="calculateEditReturnRowTotal({{ forloop.counter0 }})" required></td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm return-qty" value="{{ item.returnproduct_quantity }}" step="0.01" oninput="validateEditReturnStock({{ forloop.counter0 }})" onchange="validateEditReturnStock({{ forloop.counter0 }})" required>
                                        <div class="stock-info-edit" style="display: none;"></div>
                                        <div class="stock-error-edit" style="display: none;"></div>
                                    </td>
                                    <td><input type="number" class="form-control form-control-sm scheme" value="{{ item.returnproduct_scheme }}" step="0.01" onchange="calculateEditReturnRowTotal({{ forloop.counter0 }})"></td>
                                    <td><input type="number" class="form-control form-control-sm charges" value="{{ item.returnproduct_charges }}" step="0.01" onchange="calculateEditReturnRowTotal({{ forloop.counter0 }})"></td>
                                    <td><input type="text" class="form-control form-control-sm reason" value="{{ item.return_reason }}" maxlength="200"></td>
                                    <td><span class="edit-return-row-total">{{ item.returntotal_amount|floatformat:2 }}</span></td>
                                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeEditReturnProductRow({{ forloop.counter0 }})"><i class="fas fa-trash"></i></button></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="total-section">
                        <strong>Return Total: ‚Çπ<span id="editReturnTotal">{{ return_invoice.returninvoice_total }}</span></strong>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditPurchaseReturnModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveEditPurchaseReturn()">Save Changes</button>
        </div>
    </div>
</div>

<!-- Batch Selection Modal for Edit -->
<div id="batchSelectorModalEdit" class="batch-modal-overlay" style="display: none;">
    <div class="batch-modal-content">
        <div class="batch-modal-header">
            <h3>Select Existing Batch</h3>
            <button type="button" class="batch-modal-close" onclick="closeBatchSelectorEdit()">&times;</button>
        </div>
        <div class="batch-modal-body">
            <div class="batch-search">
                <input type="text" id="batchSearchEdit" placeholder="Search batch..." onkeyup="filterBatchesEdit()">
            </div>
            <div class="batch-list" id="batchListEdit"></div>
        </div>
        <div class="batch-modal-footer">
            <div class="batch-shortcuts">
                <small>‚Üë‚Üì: Navigate | Enter: Select | Esc: Close</small>
            </div>
            <button type="button" class="btn btn-secondary" onclick="closeBatchSelectorEdit()">Cancel</button>
        </div>
    </div>
</div>

<!-- Edit Return Modal -->
<div id="editReturnModal" class="edit-modal-overlay" style="display: none;">
    <div class="edit-modal-content">
        <div class="edit-modal-header">
            <h3><i class="fas fa-edit"></i> Edit Purchase Return</h3>
            <button type="button" class="edit-modal-close" onclick="closeEditReturnModal()">&times;</button>
        </div>
        <div class="edit-modal-body">
            <form id="editReturnForm">
                {% csrf_token %}
                <input type="hidden" id="editReturnId" value="{{ return_invoice.returninvoiceid }}">
                
                <!-- Return Details -->
                <div class="edit-section">
                    <h5>Return Details</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <label>Return Date*</label>
                            <input type="text" id="editReturnDate" class="form-control" value="{{ return_invoice.returninvoice_date|date:'dmY' }}" placeholder="DDMMYYYY" maxlength="8" required>
                        </div>
                        <div class="col-md-6">
                            <label>Return Charges</label>
                            <input type="number" id="editReturnCharges" class="form-control" value="{{ return_invoice.return_charges }}" step="0.01" min="0">
                        </div>
                    </div>
                </div>
                
                <!-- Products Section -->
                <div class="edit-section">
                    <div class="edit-products-header">
                        <h5>Return Products</h5>
                        <div class="edit-product-actions">
                            <button type="button" class="btn btn-sm btn-primary" onclick="openQuickProductSearch()">
                                <i class="fas fa-search"></i> F2: Quick Search
                            </button>
                            <button type="button" class="btn btn-sm btn-success" onclick="addEditProductRow()">
                                <i class="fas fa-plus"></i> Add Product
                            </button>
                        </div>
                    </div>
                    <div class="edit-products-table">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Batch</th>
                                    <th>Expiry</th>
                                    <th>Qty</th>
                                    <th>Rate</th>
                                    <th>Total</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="editProductRows">
                                {% for item in return_items %}
                                <tr id="editRow_{{ forloop.counter0 }}">
                                    <td>
                                        <select class="form-control form-control-sm product-select" onchange="loadEditProductInfo({{ forloop.counter0 }}, this.value)" required>
                                            <option value="">Select Product</option>
                                            {% for product in products %}
                                            <option value="{{ product.productid }}" {% if product.productid == item.returnproductid.productid %}selected{% endif %}>{{ product.product_name }} - {{ product.product_company }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td><input type="text" class="form-control form-control-sm batch-no" value="{{ item.returnproduct_batch_no }}" required></td>
                                    <td><input type="text" class="form-control form-control-sm expiry" value="{{ item.returnproduct_expiry }}" placeholder="MM-YYYY" maxlength="7" required></td>
                                    <td><input type="number" class="form-control form-control-sm return-qty" value="{{ item.returnproduct_quantity }}" step="0.01" min="0.01" onchange="calculateEditRowTotal({{ forloop.counter0 }})" required></td>
                                    <td><input type="number" class="form-control form-control-sm return-rate" value="{{ item.returnproduct_purchase_rate }}" step="0.01" min="0.01" onchange="calculateEditRowTotal({{ forloop.counter0 }})" required></td>
                                    <td><span class="edit-row-total">{{ item.returntotal_amount|floatformat:2 }}</span></td>
                                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeEditProductRow({{ forloop.counter0 }})"><i class="fas fa-trash"></i></button></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="edit-total-section">
                        <strong>Return Total: ‚Çπ<span id="editReturnTotal">{{ return_invoice.returninvoice_total }}</span></strong>
                    </div>
                </div>
            </form>
        </div>
        <div class="edit-modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditReturnModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveEditReturn()">Save Changes</button>
        </div>
    </div>
</div>

<!-- Compact Delete Confirmation Dialog -->
<div id="deleteConfirmDialog" class="delete-dialog-overlay" style="display: none;">
    <div class="delete-dialog-content">
        <div class="delete-dialog-header">
            <i class="fas fa-exclamation-triangle text-danger"></i>
            <h4>Confirm Delete</h4>
        </div>
        <div class="delete-dialog-body">
            <p>Are you sure you want to delete this item?</p>
            <div class="item-info">
                <strong id="deleteItemName"></strong>
                <small id="deleteItemBatch" class="text-muted"></small>
            </div>
        </div>
        <div class="delete-dialog-actions">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteDialog()">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
    </div>
</div>

<script>
// Delete dialog functions
let deleteItemId = null;

function showDeleteDialog(itemId, productName, batchNo) {
    deleteItemId = itemId;
    document.getElementById('deleteItemName').textContent = productName;
    document.getElementById('deleteItemBatch').textContent = `Batch: ${batchNo}`;
    document.getElementById('deleteConfirmDialog').style.display = 'flex';
    
    // Prevent body scrolling
    document.body.style.overflow = 'hidden';
}

function closeDeleteDialog() {
    document.getElementById('deleteConfirmDialog').style.display = 'none';
    document.body.style.overflow = 'auto';
    deleteItemId = null;
}

function confirmDelete() {
    if (deleteItemId) {
        // Show loading state
        const deleteBtn = document.querySelector('.delete-dialog-actions .btn-danger');
        const originalText = deleteBtn.innerHTML;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
        deleteBtn.disabled = true;
        
        // Send AJAX request to delete
        fetch(`/purchase-returns/{{ return_invoice.returninvoiceid }}/delete-item/${deleteItemId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                // Remove the row from table
                const rows = document.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const deleteButton = row.querySelector('button[onclick*="' + deleteItemId + '"]');
                    if (deleteButton) {
                        row.remove();
                    }
                });
                
                closeDeleteDialog();
                
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.innerHTML = `
                    <div style="position: fixed; top: 20px; right: 20px; background: #28a745; color: white; 
                                padding: 15px 20px; border-radius: 6px; z-index: 10001; 
                                box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
                        <i class="fas fa-check-circle"></i> Item deleted successfully
                    </div>
                `;
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    successMsg.remove();
                }, 3000);
                
                // Reload page to update totals
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                throw new Error('Delete failed');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting item. Please try again.');
            
            // Restore button state
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
        });
    }
}

// Close dialog on Escape key and confirm on Enter
document.addEventListener('keydown', function(e) {
    if (document.getElementById('deleteConfirmDialog').style.display === 'flex') {
        if (e.key === 'Escape') {
            closeDeleteDialog();
        } else if (e.key === 'Enter') {
            e.preventDefault();
            confirmDelete();
        }
    }
});

// Close dialog on overlay click
document.getElementById('deleteConfirmDialog').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteDialog();
    }
});

// Other existing functions
let editProductRowIndex = {{ return_items.count }};
let editReturnProductRowIndex = {{ return_items.count }};
let currentEditRowIndex = null;

// Main function to open the edit modal
function openEditPurchaseReturnModal() {
    const modal = document.getElementById('editPurchaseReturnModal');
    if (modal) {
        modal.style.display = 'flex';
        calculateEditReturnTotal();
        
        // Focus on return ID field after modal opens
        setTimeout(() => {
            const returnIdField = modal.querySelector('input[readonly]');
            if (returnIdField) {
                returnIdField.focus();
            }
        }, 100);
    } else {
        console.error('Modal not found');
    }
}

function closeEditPurchaseReturnModal() {
    document.getElementById('editPurchaseReturnModal').style.display = 'none';
}

function calculateEditReturnTotal() {
    let total = 0;
    document.querySelectorAll('.edit-return-row-total').forEach(span => {
        total += parseFloat(span.textContent) || 0;
    });
    
    const charges = parseFloat(document.getElementById('editReturnCharges').value) || 0;
    total += charges;
    
    document.getElementById('editReturnTotal').textContent = total.toFixed(2);
}

function saveEditPurchaseReturn() {
    // Check for stock validation errors before saving
    const stockErrors = document.querySelectorAll('input[data-stock-error="true"]');
    if (stockErrors.length > 0) {
        alert('Cannot save! Please fix stock quantity errors first.');
        stockErrors[0].focus();
        return;
    }
    
    const returnId = document.getElementById('editReturnId').value;
    const supplierId = document.getElementById('editSupplierId').value;
    const returnDate = document.getElementById('editReturnDate').value;
    const returnCharges = document.getElementById('editReturnCharges').value;
    
    const products = [];
    document.querySelectorAll('#editReturnProductRows tr').forEach(row => {
        const productSelect = row.querySelector('.product-select');
        const productId = productSelect ? productSelect.value : row.querySelector('.product-id')?.value;
        if (productId) {
            products.push({
                item_id: row.dataset.itemId || null,
                productid: productId,
                batch_no: row.querySelector('.batch-no').value,
                expiry: row.querySelector('.expiry').value,
                mrp: row.querySelector('.mrp').value,
                return_rate: row.querySelector('.return-rate').value,
                return_quantity: row.querySelector('.return-qty').value,
                scheme: row.querySelector('.scheme').value || 0,
                charges: row.querySelector('.charges').value || 0,
                reason: row.querySelector('.reason').value || ''
            });
        }
    });
    
    if (products.length === 0) {
        alert('Please add at least one product.');
        return;
    }
    
    const data = {
        return_id: returnId,
        supplier_id: supplierId,
        return_date: returnDate,
        return_charges: returnCharges,
        products: products
    };
    
    fetch('/api/update-purchase-return/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Purchase return updated successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating purchase return');
    });
}

function calculateEditReturnRowTotal(rowIndex) {
    const row = document.getElementById(`editReturnRow_${rowIndex}`);
    if (!row) return;
    
    const rate = parseFloat(row.querySelector('.return-rate').value) || 0;
    const qty = parseFloat(row.querySelector('.return-qty').value) || 0;
    const scheme = parseFloat(row.querySelector('.scheme').value) || 0;
    const charges = parseFloat(row.querySelector('.charges').value) || 0;
    
    const subtotal = rate * qty;
    const afterScheme = subtotal - scheme;
    const total = afterScheme + charges;
    
    row.querySelector('.edit-return-row-total').textContent = total.toFixed(2);
    calculateEditReturnTotal();
}

function removeEditReturnProductRow(rowIndex) {
    const row = document.getElementById(`editReturnRow_${rowIndex}`);
    if (row) {
        row.remove();
        calculateEditReturnTotal();
    }
}

function openBatchSelectorForEdit(rowIndex) {
    const row = document.getElementById(`editReturnRow_${rowIndex}`);
    const productId = row.querySelector('.product-id').value;
    
    if (!productId) {
        // Show a more user-friendly notification instead of alert
        const notification = document.createElement('div');
        notification.innerHTML = `
            <div style="position: fixed; top: 20px; right: 20px; background: #fbbf24; color: #92400e; 
                        padding: 12px 20px; border-radius: 6px; z-index: 10001; 
                        box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3); font-weight: 500;">
                <i class="fas fa-exclamation-triangle"></i> Please select a product first
            </div>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
        return;
    }
    
    currentEditRowIndex = rowIndex;
    
    fetch(`/api/product-batch-selector/?product_id=${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.batches.length > 0) {
                const batchList = document.getElementById('batchListEdit');
                batchList.innerHTML = data.batches.map((batch, index) => `
                    <div class="batch-item ${index === 0 ? 'batch-selected' : ''}" onclick="selectBatchForEdit(${rowIndex}, ${index})" data-batch='${JSON.stringify(batch)}'>
                        <div class="batch-info">
                            <div class="batch-no"><strong>${batch.batch_no}</strong></div>
                            <div class="batch-details">
                                <span>Exp: ${batch.expiry}</span>
                                <span class="${batch.stock <= 10 ? 'text-danger' : 'text-success'}">Stock: ${batch.stock}</span>
                                <span>MRP: ‚Çπ${batch.mrp}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('batchSelectorModalEdit').style.display = 'flex';
                
                setTimeout(() => {
                    const searchInput = document.getElementById('batchSearchEdit');
                    searchInput.focus();
                    
                    searchInput.addEventListener('keydown', function(e) {
                        const visibleItems = document.querySelectorAll('#batchListEdit .batch-item:not([style*="display: none"])');
                        let selectedIndex = Array.from(visibleItems).findIndex(item => item.classList.contains('batch-selected'));
                        
                        switch(e.key) {
                            case 'ArrowDown':
                                e.preventDefault();
                                if (selectedIndex < visibleItems.length - 1) {
                                    if (selectedIndex >= 0) visibleItems[selectedIndex].classList.remove('batch-selected');
                                    selectedIndex++;
                                    visibleItems[selectedIndex].classList.add('batch-selected');
                                    visibleItems[selectedIndex].scrollIntoView({ block: 'nearest' });
                                }
                                break;
                                
                            case 'ArrowUp':
                                e.preventDefault();
                                if (selectedIndex > 0) {
                                    visibleItems[selectedIndex].classList.remove('batch-selected');
                                    selectedIndex--;
                                    visibleItems[selectedIndex].classList.add('batch-selected');
                                    visibleItems[selectedIndex].scrollIntoView({ block: 'nearest' });
                                }
                                break;
                                
                            case 'Enter':
                                e.preventDefault();
                                if (selectedIndex >= 0 && visibleItems[selectedIndex]) {
                                    visibleItems[selectedIndex].click();
                                }
                                break;
                                
                            case 'Escape':
                                e.preventDefault();
                                closeBatchSelectorEdit();
                                break;
                        }
                    });
                }, 100);
            } else {
                // Show user-friendly notification for no batches
                const notification = document.createElement('div');
                notification.innerHTML = `
                    <div style="position: fixed; top: 20px; right: 20px; background: #f87171; color: #7f1d1d; 
                                padding: 12px 20px; border-radius: 6px; z-index: 10001; 
                                box-shadow: 0 4px 12px rgba(248, 113, 113, 0.3); font-weight: 500;">
                        <i class="fas fa-info-circle"></i> No batches available for this product
                    </div>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading batches');
        });
}

function selectBatchForEdit(rowIndex, batchIndex) {
    const batchItems = document.querySelectorAll('#batchListEdit .batch-item');
    const selectedBatch = JSON.parse(batchItems[batchIndex].dataset.batch);
    
    const row = document.getElementById(`editReturnRow_${rowIndex}`);
    row.querySelector('.batch-no').value = selectedBatch.batch_no;
    row.querySelector('.expiry').value = selectedBatch.expiry;
    row.querySelector('.mrp').value = selectedBatch.mrp;
    row.querySelector('.return-rate').value = selectedBatch.mrp;
    
    // Show stock info
    const stockInfo = row.querySelector('.stock-info-edit');
    if (stockInfo) {
        stockInfo.innerHTML = `<small class="text-success"><i class="fas fa-info-circle"></i> Available Stock: ${selectedBatch.stock}</small>`;
        stockInfo.style.display = 'block';
    }
    
    closeBatchSelectorEdit();
    calculateEditReturnRowTotal(rowIndex);
    
    // Focus on return rate field after batch selection for user to verify/modify
    setTimeout(() => {
        const rateField = row.querySelector('.return-rate');
        if (rateField) {
            rateField.focus();
            rateField.select();
        }
    }, 200);
}

function closeBatchSelectorEdit() {
    document.getElementById('batchSelectorModalEdit').style.display = 'none';
}

function filterBatchesEdit() {
    const searchTerm = document.getElementById('batchSearchEdit').value.toLowerCase();
    const batchItems = document.querySelectorAll('#batchListEdit .batch-item');
    
    batchItems.forEach(item => {
        const batchNo = item.querySelector('.batch-no').textContent.toLowerCase();
        if (batchNo.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function navigateBatchResults(direction) {
    const visibleItems = document.querySelectorAll('#batchListEdit .batch-item:not([style*="display: none"])');
    if (visibleItems.length === 0) return;
    
    const current = document.querySelector('#batchListEdit .batch-item.batch-selected');
    let newIndex = 0;
    
    if (current) {
        const currentIndex = Array.from(visibleItems).indexOf(current);
        newIndex = currentIndex + direction;
        
        if (newIndex < 0) newIndex = visibleItems.length - 1;
        else if (newIndex >= visibleItems.length) newIndex = 0;
        
        current.classList.remove('batch-selected');
    }
    
    visibleItems[newIndex].classList.add('batch-selected');
    visibleItems[newIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function openQuickProductSearchForEdit() {
    const modalHTML = `
        <div id="quickProductModalEdit" class="quick-search-overlay">
            <div class="quick-search-content">
                <div class="quick-search-header">
                    <h4>üîç Quick Product Search</h4>
                    <small>Type product name and press Enter</small>
                </div>
                <div class="quick-search-input">
                    <input type="text" id="quickProductInputEdit" placeholder="Type product name..." onkeyup="quickSearchProductsForEdit(event)">
                </div>
                <div class="quick-search-results" id="quickResultsEdit"></div>
                <div class="quick-search-footer">
                    <small>‚Üë‚Üì: Navigate | Enter: Select | Esc: Close</small>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    setTimeout(() => document.getElementById('quickProductInputEdit').focus(), 100);
    
    let navigationTimeout = null;
    
    document.getElementById('quickProductInputEdit').addEventListener('keydown', function(e) {
        const resultsDiv = document.getElementById('quickResultsEdit');
        
        switch(e.key) {
            case 'Escape':
                closeQuickSearchEdit();
                break;
                
            case 'ArrowDown':
                e.preventDefault();
                navigateEditResults(1);
                break;
                
            case 'ArrowUp':
                e.preventDefault();
                navigateEditResults(-1);
                break;
                
            case 'Enter':
                e.preventDefault();
                e.stopPropagation();
                
                // Get selected item or first item if none selected
                let selected = resultsDiv.querySelector('.selected');
                if (!selected) {
                    selected = resultsDiv.querySelector('.quick-result-item');
                }
                
                if (selected) {
                    // Extract product info and call selection function directly
                    const productName = selected.querySelector('.product-name').textContent;
                    const productCompany = selected.querySelector('.product-company').textContent;
                    
                    // Find product ID from the products array
                    const products = [{% for product in products %}{
                        id: {{ product.productid }},
                        name: '{{ product.product_name|escapejs }}',
                        company: '{{ product.product_company|escapejs }}'
                    },{% endfor %}];
                    
                    const matchedProduct = products.find(p => 
                        p.name === productName && p.company === productCompany
                    );
                    
                    if (matchedProduct) {
                        quickSelectEditReturnProduct(matchedProduct.id, matchedProduct.name);
                    }
                }
                break;
                
            case 'Home':
                e.preventDefault();
                const firstItem = resultsDiv.querySelector('.quick-result-item');
                if (firstItem) {
                    resultsDiv.querySelectorAll('.quick-result-item').forEach(item => 
                        item.classList.remove('selected'));
                    firstItem.classList.add('selected');
                    firstItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                break;
                
            case 'End':
                e.preventDefault();
                const items = resultsDiv.querySelectorAll('.quick-result-item');
                if (items.length > 0) {
                    items.forEach(item => item.classList.remove('selected'));
                    const lastItem = items[items.length - 1];
                    lastItem.classList.add('selected');
                    lastItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                break;
        }
    });
    

}

function quickSearchProductsForEdit(event) {
    const originalSearchTerm = event.target.value;
    const searchTerm = originalSearchTerm.toLowerCase();
    const resultsDiv = document.getElementById('quickResultsEdit');
    
    // Skip navigation keys - handled in keydown event
    if (['ArrowDown', 'ArrowUp', 'Enter', 'Escape', 'Home', 'End'].includes(event.key)) {
        return;
    }
    
    // Handle search input
    if (originalSearchTerm.length < 2) {
        resultsDiv.innerHTML = '<div class="quick-hint">Type at least 2 characters...</div>';
        return;
    }
    
    // Filter products from existing data
    const products = [{% for product in products %}{
        id: {{ product.productid }},
        name: '{{ product.product_name|escapejs }}',
        company: '{{ product.product_company|escapejs }}'
    },{% endfor %}];
    
    // Filter products that START with the search term (first 2+ letters)
    const filtered = products.filter(p => {
        // Primary filter: starts with search term (case-sensitive first, then case-insensitive)
        const exactStartsName = p.name.startsWith(originalSearchTerm);
        const exactStartsCompany = p.company.startsWith(originalSearchTerm);
        const startsName = p.name.toLowerCase().startsWith(searchTerm);
        const startsCompany = p.company.toLowerCase().startsWith(searchTerm);
        
        return exactStartsName || exactStartsCompany || startsName || startsCompany;
    }).sort((a, b) => {
        // Priority scoring for "starts with" matches
        let aScore = 0;
        let bScore = 0;
        
        // Exact case "starts with" gets highest priority (100 points)
        if (a.name.startsWith(originalSearchTerm)) aScore += 100;
        if (a.company.startsWith(originalSearchTerm)) aScore += 90;
        if (b.name.startsWith(originalSearchTerm)) bScore += 100;
        if (b.company.startsWith(originalSearchTerm)) bScore += 90;
        
        // Case-insensitive "starts with" gets medium priority (50 points)
        if (a.name.toLowerCase().startsWith(searchTerm)) aScore += 50;
        if (a.company.toLowerCase().startsWith(searchTerm)) aScore += 40;
        if (b.name.toLowerCase().startsWith(searchTerm)) bScore += 50;
        if (b.company.toLowerCase().startsWith(searchTerm)) bScore += 40;
        
        // Sort by score (higher score first)
        if (aScore !== bScore) {
            return bScore - aScore;
        }
        
        // If scores are equal, sort alphabetically
        return a.name.localeCompare(b.name);
    });
    
    if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">No products starting with "' + originalSearchTerm + '" found</div>';
        return;
    }
    
    resultsDiv.innerHTML = filtered.map((product, index) => `
        <div class="quick-result-item ${index === 0 ? 'selected' : ''}" 
             onclick="quickSelectEditReturnProduct(${product.id}, '${product.name}')">
            <div class="product-name">${product.name}</div>
            <div class="product-company">${product.company}</div>
        </div>
    `).join('');
}

function quickSelectEditReturnProduct(productId, productName) {
    const tbody = document.getElementById('editReturnProductRows');
    const row = document.createElement('tr');
    row.id = `editReturnRow_${editReturnProductRowIndex}`;
    
    row.innerHTML = `
        <td>
            <button type="button" class="btn btn-sm btn-info" onclick="openBatchSelectorForEdit(${editReturnProductRowIndex})" title="Select Batch (Alt+W)">
                <i class="fas fa-box"></i> <small>Alt+W</small>
            </button>
            <input type="hidden" class="product-id" value="${productId}">
            <small class="product-name">${productName}</small>
        </td>
        <td><input type="text" class="form-control form-control-sm batch-no" placeholder="Enter batch number"></td>
        <td><input type="text" class="form-control form-control-sm expiry" placeholder="Auto-filled"></td>
        <td><input type="number" class="form-control form-control-sm mrp" step="0.01" placeholder="Auto-filled"></td>
        <td><input type="number" class="form-control form-control-sm return-rate" step="0.01" onchange="calculateEditReturnRowTotal(${editReturnProductRowIndex})" placeholder="Return rate" required></td>
        <td>
            <input type="number" class="form-control form-control-sm return-qty" step="0.01" oninput="validateEditReturnStock(${editReturnProductRowIndex})" onchange="validateEditReturnStock(${editReturnProductRowIndex})" placeholder="Quantity" required>
            <div class="stock-info-edit" style="display: none;"></div>
            <div class="stock-error-edit" style="display: none;"></div>
        </td>
        <td><input type="number" class="form-control form-control-sm scheme" step="0.01" onchange="calculateEditReturnRowTotal(${editReturnProductRowIndex})" placeholder="Scheme"></td>
        <td><input type="number" class="form-control form-control-sm charges" step="0.01" onchange="calculateEditReturnRowTotal(${editReturnProductRowIndex})" placeholder="Charges"></td>
        <td><input type="text" class="form-control form-control-sm reason" maxlength="200" placeholder="Return reason"></td>
        <td><span class="edit-return-row-total">0.00</span></td>
        <td><button type="button" class="btn btn-sm btn-danger" onclick="removeEditReturnProductRow(${editReturnProductRowIndex})"><i class="fas fa-trash"></i></button></td>
    `;
    
    tbody.appendChild(row);
    editReturnProductRowIndex++;
    closeQuickSearchEdit();
    
    // Focus on batch number input field
    setTimeout(() => {
        const batchInput = row.querySelector('.batch-no');
        if (batchInput) {
            batchInput.focus();
        }
    }, 100);
}

function closeQuickSearchEdit() {
    const modal = document.getElementById('quickProductModalEdit');
    if (modal) modal.remove();
}

let navigationThrottle = false;

function navigateEditResults(direction) {
    // Throttle navigation to prevent too fast movement
    if (navigationThrottle) return;
    navigationThrottle = true;
    
    setTimeout(() => {
        navigationThrottle = false;
    }, 150); // 150ms delay between navigations
    
    const items = document.querySelectorAll('#quickResultsEdit .quick-result-item');
    if (items.length === 0) return;
    
    const current = document.querySelector('#quickResultsEdit .quick-result-item.selected');
    let newIndex = 0;
    
    if (current) {
        const currentIndex = Array.from(items).indexOf(current);
        newIndex = currentIndex + direction;
        
        // Wrap around navigation
        if (newIndex < 0) {
            newIndex = items.length - 1;
        } else if (newIndex >= items.length) {
            newIndex = 0;
        }
        
        current.classList.remove('selected');
    } else {
        // If no item selected, select first or last based on direction
        newIndex = direction > 0 ? 0 : items.length - 1;
    }
    
    items[newIndex].classList.add('selected');
    
    // Scroll selected item into view
    items[newIndex].scrollIntoView({
        behavior: 'smooth',
        block: 'nearest'
    });
}

function loadEditReturnProductInfo(rowIndex, productId) {
    if (!productId) return;
    
    const row = document.getElementById(`editReturnRow_${rowIndex}`);
    row.querySelector('.product-id').value = productId;
    
    fetch(`/get-product-info/?product_id=${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) return;
            
            if (row) {
                row.querySelector('.batch-no').value = data.last_batch_no || '';
                row.querySelector('.expiry').value = data.last_expiry || '';
                row.querySelector('.mrp').value = data.last_mrp || '';
                row.querySelector('.return-rate').value = data.last_purchase_rate || '';
                
                // Show stock info if available
                if (data.last_stock) {
                    const stockInfo = row.querySelector('.stock-info-edit');
                    if (stockInfo) {
                        stockInfo.innerHTML = `<small class="text-success"><i class="fas fa-info-circle"></i> Available Stock: ${data.last_stock}</small>`;
                        stockInfo.style.display = 'block';
                    }
                }
                
                calculateEditReturnRowTotal(rowIndex);
            }
        })
        .catch(error => console.error('Error:', error));
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'F2' && document.getElementById('editPurchaseReturnModal').style.display === 'flex') {
        e.preventDefault();
        openQuickProductSearchForEdit();
    }
    
    // Alt+W for batch selection - only when focused on a product row
    if (e.altKey && e.key.toLowerCase() === 'w' && document.getElementById('editPurchaseReturnModal').style.display === 'flex') {
        e.preventDefault();
        
        // Find the currently focused row or the last added row
        const focusedElement = document.activeElement;
        let targetRowIndex = null;
        
        // Check if focused element is within a product row
        const productRow = focusedElement.closest('tr[id^="editReturnRow_"]');
        if (productRow) {
            const rowId = productRow.id;
            targetRowIndex = parseInt(rowId.split('_')[1]);
        } else {
            // If no specific row is focused, find the last row with a product selected
            const allRows = document.querySelectorAll('#editReturnProductRows tr');
            for (let i = allRows.length - 1; i >= 0; i--) {
                const row = allRows[i];
                const productId = row.querySelector('.product-id')?.value;
                if (productId) {
                    const rowId = row.id;
                    targetRowIndex = parseInt(rowId.split('_')[1]);
                    break;
                }
            }
        }
        
        // Open batch selector for the target row if found
        if (targetRowIndex !== null) {
            openBatchSelectorForEdit(targetRowIndex);
        } else {
            // Show a helpful message if no product row is available
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #fbbf24; color: #92400e; 
                            padding: 12px 20px; border-radius: 6px; z-index: 10001; 
                            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3); font-weight: 500;">
                    <i class="fas fa-info-circle"></i> Please select a product first to choose batch
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    }
});

function openEditReturnModal() {
    document.getElementById('editReturnModal').style.display = 'flex';
    calculateEditReturnTotal();
}

function closeEditReturnModal() {
    document.getElementById('editReturnModal').style.display = 'none';
}

function addEditProductRow() {
    const tbody = document.getElementById('editProductRows');
    const row = document.createElement('tr');
    row.id = `editRow_${editProductRowIndex}`;
    
    row.innerHTML = `
        <td>
            <select class="form-control form-control-sm product-select" onchange="loadEditProductInfo(${editProductRowIndex}, this.value)" required>
                <option value="">Select Product</option>
                {% for product in products %}
                <option value="{{ product.productid }}">{{ product.product_name }} - {{ product.product_company }}</option>
                {% endfor %}
            </select>
        </td>
        <td><input type="text" class="form-control form-control-sm batch-no" placeholder="Batch No" required></td>
        <td><input type="text" class="form-control form-control-sm expiry" placeholder="MMYYYY" maxlength="6" required></td>
        <td><input type="number" class="form-control form-control-sm return-qty" placeholder="Qty" step="0.01" min="0.01" onchange="calculateEditRowTotal(${editProductRowIndex})" required></td>
        <td><input type="number" class="form-control form-control-sm return-rate" placeholder="Rate" step="0.01" min="0.01" onchange="calculateEditRowTotal(${editProductRowIndex})" required></td>
        <td><span class="edit-row-total">0.00</span></td>
        <td><button type="button" class="btn btn-sm btn-danger" onclick="removeEditProductRow(${editProductRowIndex})"><i class="fas fa-trash"></i></button></td>
    `;
    
    tbody.appendChild(row);
    editProductRowIndex++;
}

function removeEditProductRow(rowIndex) {
    const row = document.getElementById(`editRow_${rowIndex}`);
    if (row) {
        row.remove();
        calculateEditReturnTotal();
    }
}

function calculateEditRowTotal(rowIndex) {
    const row = document.getElementById(`editRow_${rowIndex}`);
    if (!row) return;
    
    const rate = parseFloat(row.querySelector('.return-rate').value) || 0;
    const qty = parseFloat(row.querySelector('.return-qty').value) || 0;
    const total = rate * qty;
    
    row.querySelector('.edit-row-total').textContent = total.toFixed(2);
    calculateEditReturnTotal();
}

function loadEditProductInfo(rowIndex, productId) {
    if (!productId) return;
    
    fetch(`/get-product-info/?product_id=${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) return;
            
            const row = document.getElementById(`editRow_${rowIndex}`);
            if (row) {
                row.querySelector('.batch-no').value = data.last_batch_no || '';
                row.querySelector('.expiry').value = data.last_expiry || '';
                row.querySelector('.return-rate').value = data.last_purchase_rate || '';
                calculateEditRowTotal(rowIndex);
            }
        })
        .catch(error => console.error('Error:', error));
}

function openQuickProductSearch() {
    const modalHTML = `
        <div id="quickProductModal" class="quick-search-overlay">
            <div class="quick-search-content">
                <div class="quick-search-header">
                    <h4>üîç Quick Product Search</h4>
                    <small>Type product name and press Enter</small>
                </div>
                <div class="quick-search-input">
                    <input type="text" id="quickProductInput" placeholder="Type product name..." onkeyup="quickSearchProducts(event)">
                </div>
                <div class="quick-search-results" id="quickResults"></div>
                <div class="quick-search-footer">
                    <small>‚Üë‚Üì: Navigate | Enter: Select | Esc: Close</small>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    setTimeout(() => {
        document.getElementById('quickProductInput').focus();
        
        document.getElementById('quickProductInput').addEventListener('keydown', function(e) {
            const resultsDiv = document.getElementById('quickResults');
            
            switch(e.key) {
                case 'Escape':
                    closeQuickSearch();
                    break;
                    
                case 'ArrowDown':
                    e.preventDefault();
                    navigateResults(1);
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    navigateResults(-1);
                    break;
                    
                case 'Enter':
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Get selected item or first item if none selected
                    let selected = resultsDiv.querySelector('.selected');
                    if (!selected) {
                        selected = resultsDiv.querySelector('.quick-result-item');
                    }
                    
                    if (selected) {
                        // Extract product info and call selection function directly
                        const productName = selected.querySelector('.product-name').textContent;
                        const productCompany = selected.querySelector('.product-company').textContent;
                        
                        // Find product ID from the products array
                        const products = [{% for product in products %}{
                            id: {{ product.productid }},
                            name: '{{ product.product_name|escapejs }}',
                            company: '{{ product.product_company|escapejs }}'
                        },{% endfor %}];
                        
                        const matchedProduct = products.find(p => 
                            p.name === productName && p.company === productCompany
                        );
                        
                        if (matchedProduct) {
                            quickSelectEditProduct(matchedProduct.id);
                        }
                    }
                    break;
                    
                case 'Home':
                    e.preventDefault();
                    const firstItem = resultsDiv.querySelector('.quick-result-item');
                    if (firstItem) {
                        resultsDiv.querySelectorAll('.quick-result-item').forEach(item => 
                            item.classList.remove('selected'));
                        firstItem.classList.add('selected');
                        firstItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                    break;
                    
                case 'End':
                    e.preventDefault();
                    const items = resultsDiv.querySelectorAll('.quick-result-item');
                    if (items.length > 0) {
                        items.forEach(item => item.classList.remove('selected'));
                        const lastItem = items[items.length - 1];
                        lastItem.classList.add('selected');
                        lastItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                    break;
            }
        });
    }, 100);
}

function quickSearchProducts(event) {
    const originalSearchTerm = event.target.value;
    const searchTerm = originalSearchTerm.toLowerCase();
    const resultsDiv = document.getElementById('quickResults');
    
    // Skip navigation keys - handled in keydown event
    if (['ArrowDown', 'ArrowUp', 'Enter', 'Escape', 'Home', 'End'].includes(event.key)) {
        return;
    }
    
    // Handle search input
    if (originalSearchTerm.length < 2) {
        resultsDiv.innerHTML = '<div class="quick-hint">Type at least 2 characters...</div>';
        return;
    }
    
    // Filter products from existing data
    const products = [{% for product in products %}{
        id: {{ product.productid }},
        name: '{{ product.product_name|escapejs }}',
        company: '{{ product.product_company|escapejs }}'
    },{% endfor %}];
    
    // Filter products that START with the search term (first 2+ letters)
    const filtered = products.filter(p => {
        // Primary filter: starts with search term (case-sensitive first, then case-insensitive)
        const exactStartsName = p.name.startsWith(originalSearchTerm);
        const exactStartsCompany = p.company.startsWith(originalSearchTerm);
        const startsName = p.name.toLowerCase().startsWith(searchTerm);
        const startsCompany = p.company.toLowerCase().startsWith(searchTerm);
        
        return exactStartsName || exactStartsCompany || startsName || startsCompany;
    }).sort((a, b) => {
        // Priority scoring for "starts with" matches
        let aScore = 0;
        let bScore = 0;
        
        // Exact case "starts with" gets highest priority (100 points)
        if (a.name.startsWith(originalSearchTerm)) aScore += 100;
        if (a.company.startsWith(originalSearchTerm)) aScore += 90;
        if (b.name.startsWith(originalSearchTerm)) bScore += 100;
        if (b.company.startsWith(originalSearchTerm)) bScore += 90;
        
        // Case-insensitive "starts with" gets medium priority (50 points)
        if (a.name.toLowerCase().startsWith(searchTerm)) aScore += 50;
        if (a.company.toLowerCase().startsWith(searchTerm)) aScore += 40;
        if (b.name.toLowerCase().startsWith(searchTerm)) bScore += 50;
        if (b.company.toLowerCase().startsWith(searchTerm)) bScore += 40;
        
        // Sort by score (higher score first)
        if (aScore !== bScore) {
            return bScore - aScore;
        }
        
        // If scores are equal, sort alphabetically
        return a.name.localeCompare(b.name);
    });
    
    if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">No products starting with "' + originalSearchTerm + '" found</div>';
        return;
    }
    
    resultsDiv.innerHTML = filtered.map((product, index) => `
        <div class="quick-result-item ${index === 0 ? 'selected' : ''}" 
             onclick="quickSelectEditProduct(${product.id})">
            <div class="product-name">${product.name}</div>
            <div class="product-company">${product.company}</div>
        </div>
    `).join('');
}

function navigateResults(direction) {
    // Throttle navigation to prevent too fast movement
    if (navigationThrottle) return;
    navigationThrottle = true;
    
    setTimeout(() => {
        navigationThrottle = false;
    }, 150); // 150ms delay between navigations
    
    const items = document.querySelectorAll('.quick-result-item');
    if (items.length === 0) return;
    
    const current = document.querySelector('.quick-result-item.selected');
    let newIndex = 0;
    
    if (current) {
        const currentIndex = Array.from(items).indexOf(current);
        newIndex = currentIndex + direction;
        
        // Wrap around navigation
        if (newIndex < 0) {
            newIndex = items.length - 1;
        } else if (newIndex >= items.length) {
            newIndex = 0;
        }
        
        current.classList.remove('selected');
    } else {
        // If no item selected, select first or last based on direction
        newIndex = direction > 0 ? 0 : items.length - 1;
    }
    
    items[newIndex].classList.add('selected');
    
    // Scroll selected item into view
    items[newIndex].scrollIntoView({
        behavior: 'smooth',
        block: 'nearest'
    });
}

function quickSelectEditProduct(productId) {
    const rows = document.querySelectorAll('#editProductRows tr');
    let targetRow = null;
    
    for (let row of rows) {
        const productSelect = row.querySelector('.product-select');
        if (productSelect && !productSelect.value) {
            targetRow = row;
            break;
        }
    }
    
    if (!targetRow) {
        addEditProductRow();
        setTimeout(() => {
            const newRows = document.querySelectorAll('#editProductRows tr');
            targetRow = newRows[newRows.length - 1];
            fillEditProductInRow(targetRow, productId);
        }, 100);
    } else {
        fillEditProductInRow(targetRow, productId);
    }
    
    closeQuickSearch();
}

function fillEditProductInRow(row, productId) {
    const productSelect = row.querySelector('.product-select');
    if (productSelect) {
        productSelect.value = productId;
        const rowIndex = row.id.split('_')[1];
        loadEditProductInfo(rowIndex, productId);
    }
}

function closeQuickSearch() {
    const modal = document.getElementById('quickProductModal');
    if (modal) modal.remove();
}

function saveEditReturn() {
    const returnId = document.getElementById('editReturnId').value;
    const returnDate = document.getElementById('editReturnDate').value;
    const returnCharges = document.getElementById('editReturnCharges').value;
    
    const products = [];
    document.querySelectorAll('#editProductRows tr').forEach(row => {
        const productSelect = row.querySelector('.product-select');
        if (productSelect && productSelect.value) {
            products.push({
                productid: productSelect.value,
                batch_no: row.querySelector('.batch-no').value,
                expiry: row.querySelector('.expiry').value,
                return_quantity: row.querySelector('.return-qty').value,
                return_rate: row.querySelector('.return-rate').value
            });
        }
    });
    
    if (products.length === 0) {
        alert('Please add at least one product.');
        return;
    }
    
    const data = {
        return_id: returnId,
        return_date: returnDate,
        return_charges: returnCharges,
        products: products
    };
    
    fetch('/api/update-purchase-return/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Purchase return updated successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating purchase return');
    });
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'F2' && document.getElementById('editReturnModal').style.display === 'flex') {
        e.preventDefault();
        openQuickProductSearch();
    }
    
    if (e.ctrlKey && e.key === 'Enter' && document.getElementById('editReturnModal').style.display === 'flex') {
        e.preventDefault();
        addEditProductRow();
    }
});

// Stock validation function for edit return
function validateEditReturnStock(rowIndex) {
    const row = document.getElementById(`editReturnRow_${rowIndex}`);
    if (!row) return;
    
    const quantityInput = row.querySelector('.return-qty');
    const stockInfo = row.querySelector('.stock-info-edit');
    const stockError = row.querySelector('.stock-error-edit');
    const quantity = parseFloat(quantityInput.value) || 0;
    
    // Get available stock from stock info
    let availableStock = 0;
    if (stockInfo && stockInfo.textContent) {
        const stockMatch = stockInfo.textContent.match(/Available Stock: (\d+(?:\.\d+)?)/i);
        if (stockMatch) {
            availableStock = parseFloat(stockMatch[1]);
        }
    }
    
    // Enhanced validation for zero stock and excess quantity
    if ((availableStock === 0 && quantity > 0) || (availableStock > 0 && quantity > availableStock)) {
        let errorMsg;
        if (availableStock === 0) {
            errorMsg = 'Out of stock! This batch is not available';
        } else {
            errorMsg = `Insufficient stock! Available: ${availableStock} units`;
        }
        
        stockError.innerHTML = `<small class="text-danger"><i class="fas fa-exclamation-triangle"></i> ${errorMsg}</small>`;
        stockError.style.display = 'block';
        
        quantityInput.style.borderColor = '#dc3545';
        quantityInput.style.backgroundColor = '#f8d7da';
        quantityInput.setAttribute('data-stock-error', 'true');
        
        // Block all inputs and save button
        lockEditReturnForm(true);
        
        return false;
    } else {
        stockError.style.display = 'none';
        quantityInput.style.borderColor = '';
        quantityInput.style.backgroundColor = '';
        quantityInput.removeAttribute('data-stock-error');
        
        // Check if any other stock errors exist
        const hasOtherErrors = document.querySelector('input[data-stock-error="true"]');
        if (!hasOtherErrors) {
            lockEditReturnForm(false);
        }
    }
    
    calculateEditReturnRowTotal(rowIndex);
    return true;
}

// Function to lock/unlock edit return form
function lockEditReturnForm(lock) {
    const modal = document.getElementById('editPurchaseReturnModal');
    const inputs = modal.querySelectorAll('input:not(.return-qty[data-stock-error="true"]), select, button');
    const saveBtn = modal.querySelector('.btn-primary');
    
    inputs.forEach(input => {
        if (lock) {
            input.disabled = true;
            input.style.opacity = '0.5';
        } else {
            input.disabled = false;
            input.style.opacity = '1';
        }
    });
    
    // Handle save button
    if (saveBtn) {
        if (lock) {
            saveBtn.innerHTML = '<i class="fas fa-ban"></i> Fix Stock Errors First';
            saveBtn.classList.add('btn-danger');
            saveBtn.classList.remove('btn-primary');
            saveBtn.disabled = true;
        } else {
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            saveBtn.classList.add('btn-primary');
            saveBtn.classList.remove('btn-danger');
            saveBtn.disabled = false;
        }
    }
    
    // Show/hide error overlay
    let overlay = document.getElementById('editStockErrorOverlay');
    if (lock && !overlay) {
        overlay = document.createElement('div');
        overlay.id = 'editStockErrorOverlay';
        overlay.innerHTML = `
            <div style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
                        background: linear-gradient(135deg, #dc3545, #c82333); color: white; 
                        padding: 15px 25px; border-radius: 8px; z-index: 10001; 
                        font-weight: bold; box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <div>Stock Validation Error</div>
                        <small style="opacity: 0.9;">Correct the quantity to continue</small>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
    } else if (!lock && overlay) {
        overlay.remove();
    }
}

// Auto-calculate charges
document.addEventListener('DOMContentLoaded', function() {
    const chargesInput = document.getElementById('editReturnCharges');
    if (chargesInput) {
        chargesInput.addEventListener('input', calculateEditReturnTotal);
    }
});

// Keyboard shortcut Ctrl+E for edit
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        openEditPurchaseReturnModal();
    }
});
</script>

<style>
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content-large {
    background: white;
    border-radius: 8px;
    width: 95%;
    max-width: 1400px;
    max-height: 95vh;
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

/* Compact Edit Return Layout */
.edit-return-header-row {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.edit-return-field {
    flex: 1;
    min-width: 200px;
}

.edit-return-field label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #333;
    font-size: 14px;
}

.edit-return-field .form-control {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.edit-return-field .form-control:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

/* Stock validation styles */
.stock-info-edit {
    margin-top: 4px;
    padding: 2px 6px;
    background: rgba(40, 167, 69, 0.1);
    border-radius: 3px;
    border-left: 3px solid #28a745;
}

.stock-error-edit {
    margin-top: 4px;
    padding: 2px 6px;
    background: rgba(220, 53, 69, 0.1);
    border-radius: 3px;
    border-left: 3px solid #dc3545;
}

/* Compact table styling */
.products-section .table {
    font-size: 13px;
}

.products-section .table th,
.products-section .table td {
    padding: 6px 8px;
    vertical-align: middle;
}

.products-section .form-control-sm {
    padding: 4px 8px;
    font-size: 12px;
    height: auto;
}

/* Batch button styling */
.btn-info {
    background-color: #17a2b8;
    border-color: #17a2b8;
    color: white;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
}

.btn-info:hover {
    background-color: #138496;
    border-color: #117a8b;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
}

.btn-info:focus {
    box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.25);
    outline: none;
}

.btn-info small {
    font-size: 9px;
    opacity: 0.9;
    font-weight: 500;
}

/* Product actions styling */
.product-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}

.product-actions small {
    font-size: 11px;
    color: #6c757d;
    font-weight: 500;
}

/* Modal body compact */
.modal-body {
    padding: 15px 20px;
}

.products-header {
    margin-bottom: 10px;
}

.total-section {
    margin-top: 10px;
    padding: 8px;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #e5e5e5;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    background: #f8f9fa;
}

.products-section {
    margin-top: 20px;
}

.products-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.product-actions {
    display: flex;
    gap: 10px;
}

.total-section {
    text-align: right;
    margin-top: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
}

.batch-item {
    padding: 10px;
    border: 1px solid #ddd;
    margin: 5px 0;
    cursor: pointer;
    border-radius: 4px;
}

.batch-item:hover {
    background: #f0f0f0;
}

.edit-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.edit-modal-content {
    background: white;
    border-radius: 8px;
    width: 95%;
    max-width: 1200px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.edit-modal-header {
    padding: 20px;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
}

.edit-modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

.edit-modal-body {
    padding: 20px;
}

.edit-section {
    margin-bottom: 30px;
}

.edit-products-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.edit-product-actions {
    display: flex;
    gap: 10px;
}

.edit-products-table {
    max-height: 300px;
    overflow-y: auto;
}

.edit-total-section {
    text-align: right;
    margin-top: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
}

.edit-modal-footer {
    padding: 20px;
    border-top: 1px solid #e5e5e5;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    background: #f8f9fa;
}

/* Quick Search Styles */
.quick-search-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1001;
}

.quick-search-content {
    background: white;
    border-radius: 10px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.quick-search-header {
    background: #059669;
    color: white;
    padding: 20px;
    text-align: center;
}

.quick-search-input {
    padding: 20px;
}

.quick-search-input input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    font-size: 1rem;
    outline: none;
}

.quick-search-results {
    max-height: 300px;
    overflow-y: auto;
    padding: 0 20px;
}

.quick-result-item {
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
    cursor: pointer;
    transition: background-color 0.2s;
}

.quick-result-item:hover,
.quick-result-item.selected {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
    transform: translateX(2px);
}

.product-name {
    font-weight: 600;
    color: #374151;
}

.product-company {
    font-size: 0.9rem;
    color: #6b7280;
    margin-top: 2px;
}

.quick-hint,
.no-results {
    text-align: center;
    padding: 20px;
    color: #6b7280;
    font-style: italic;
}

.quick-search-footer {
    background: #f9fafb;
    padding: 15px 20px;
    text-align: center;
    border-top: 1px solid #e5e7eb;
}

/* Batch Modal Styles */
.batch-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1001;
}

.batch-modal-content {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.batch-modal-header {
    padding: 20px;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
}

.batch-modal-header h3 {
    margin: 0;
    color: #333;
    font-size: 18px;
}

.batch-modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.batch-modal-close:hover {
    color: #000;
}

.batch-modal-body {
    padding: 20px;
    max-height: 400px;
    overflow-y: auto;
}

.batch-search {
    margin-bottom: 15px;
}

.batch-search input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.batch-search input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.batch-list {
    max-height: 300px;
    overflow-y: auto;
}

.batch-item {
    padding: 12px;
    border: 1px solid #e5e5e5;
    border-radius: 4px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
    background: white;
}

.batch-item:hover,
.batch-item.batch-selected {
    background: #f0f8ff;
    border-color: #007bff;
    box-shadow: 0 2px 4px rgba(0, 123, 255, 0.1);
}

.batch-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.batch-no {
    font-size: 16px;
    color: #333;
}

.batch-details {
    display: flex;
    gap: 15px;
    font-size: 14px;
    color: #666;
}

.batch-details span {
    white-space: nowrap;
}

.text-danger {
    color: #dc3545 !important;
    font-weight: bold;
}

.text-success {
    color: #28a745 !important;
    font-weight: bold;
}

.batch-modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #e5e5e5;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
}

.batch-shortcuts {
    font-size: 12px;
    color: #666;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.2s;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #545b62;
}

/* Highlighting */
mark {
    background: #ffeb3b;
    color: #000;
    padding: 1px 2px;
    border-radius: 2px;
    font-weight: bold;
}

/* Compact Delete Dialog Styles */
.delete-dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(2px);
}

.delete-dialog-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    animation: deleteDialogSlideIn 0.2s ease-out;
    overflow: hidden;
}

@keyframes deleteDialogSlideIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.delete-dialog-header {
    padding: 20px 24px 16px;
    text-align: center;
    border-bottom: 1px solid #f1f3f4;
}

.delete-dialog-header i {
    font-size: 2.5rem;
    margin-bottom: 8px;
    display: block;
}

.delete-dialog-header h4 {
    margin: 0;
    color: #333;
    font-size: 1.25rem;
    font-weight: 600;
}

.delete-dialog-body {
    padding: 16px 24px;
    text-align: center;
}

.delete-dialog-body p {
    margin: 0 0 12px;
    color: #666;
    font-size: 1rem;
}

.item-info {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 6px;
    border-left: 4px solid #dc3545;
}

.item-info strong {
    display: block;
    color: #333;
    font-size: 1rem;
    margin-bottom: 4px;
}

.item-info small {
    display: block;
    font-size: 0.875rem;
}

.delete-dialog-actions {
    padding: 16px 24px 20px;
    display: flex;
    gap: 12px;
    justify-content: center;
}

.delete-dialog-actions .btn {
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: 500;
    font-size: 0.9rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 90px;
}

.delete-dialog-actions .btn-secondary {
    background: #6c757d;
    color: white;
}

.delete-dialog-actions .btn-secondary:hover {
    background: #545b62;
    transform: translateY(-1px);
}

.delete-dialog-actions .btn-danger {
    background: #dc3545;
    color: white;
}

.delete-dialog-actions .btn-danger:hover {
    background: #c82333;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}

@media (max-width: 768px) {
    .batch-modal-content {
        width: 95%;
        margin: 10px;
    }
    
    .batch-details {
        flex-direction: column;
        gap: 5px;
    }
    
    .batch-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .delete-dialog-content {
        width: 95%;
        margin: 20px;
    }
    
    .delete-dialog-actions {
        flex-direction: column;
    }
    
    .delete-dialog-actions .btn {
        width: 100%;
    }
}
</style>
<div style="position: fixed; bottom: 0; left: 0; right: 0; background: #1f2937; color: #d1d5db; padding: 10px 20px; font-size: 0.8rem; display: flex; justify-content: center; gap: 30px; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
    <div style="display: flex; align-items: center; gap: 5px;">
        <span style="background: #374151; padding: 2px 6px; border-radius: 3px; font-weight: 600; font-size: 0.7rem;">Ctrl+E</span>
        <span>Edit Invoice</span>
    </div>
    <div style="display: flex; align-items: center; gap: 5px;">
        <span style="background: #374151; padding: 2px 6px; border-radius: 3px; font-weight: 600; font-size: 0.7rem;">Ctrl+P</span>
        <span>Print receipt</span>
    </div>
    <!-- <div style="display: flex; align-items: center; gap: 5px;">
        <span style="background: #374151; padding: 2px 6px; border-radius: 3px; font-weight: 600; font-size: 0.7rem;">Alt+W</span>
        <span>Batch Selector</span>
    </div> -->
    <!-- <div style="display: flex; align-items: center; gap: 5px;">
        <span style="background: #374151; padding: 2px 6px; border-radius: 3px; font-weight: 600; font-size: 0.7rem;">Ctrl+S</span>
        <span>Save Invoice</span>
    </div> -->
    <!-- <div style="display: flex; align-items: center; gap: 5px;">
        <span style="background: #374151; padding: 2px 6px; border-radius: 3px; font-weight: 600; font-size: 0.7rem;">Ctrl+D</span>
        <span>Duplicate Row</span>
    </div> -->
</div>
{% endblock %}