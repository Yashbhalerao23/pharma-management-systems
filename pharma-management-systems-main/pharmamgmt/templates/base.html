{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <meta name="description" content="Modern Pharmacy Management System with Beautiful UI">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %}Pharmacy Management System{% endblock %}</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    

    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Master Global CSS (Load First) -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Page specific CSS -->
    {% block extra_css %}{% endblock %}
    
    <!-- Critical Input Fix Only -->
    <style>
    input, textarea, select {
        background-color: #ffffff !important;
        color: #1f2937 !important;
        -webkit-text-fill-color: #1f2937 !important;
    }
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus {
        -webkit-box-shadow: 0 0 0 1000px #ffffff inset !important;
        -webkit-text-fill-color: #1f2937 !important;
    }
    </style>
</head>
<body class="body-gradient">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loader-container">
            <div class="pharma-logo-main loader-logo">
                <!-- Medical Cross with Glow -->
                <div class="medical-cross">
                    <div class="cross-vertical"></div>
                    <div class="cross-horizontal"></div>
                    <div class="cross-glow"></div>
                </div>
                
                <!-- Rotating Pills -->
                <div class="pills-orbit">
                    <div class="pill pill-1"></div>
                    <div class="pill pill-2"></div>
                    <div class="pill pill-3"></div>
                </div>
                
                <!-- Pulse Rings -->
                <div class="pulse-ring ring-1"></div>
                <div class="pulse-ring ring-2"></div>
                <div class="pulse-ring ring-3"></div>
            </div>
            
            <div class="loading-text">PharmaMgmt</div>
            <div class="loading-subtitle">Loading...</div>
        </div>
    </div>
    
    <div class="main-container" id="mainContainer" style="display: none;">
        <!-- Sidebar -->
        {% include 'sidebar.html' %}

        
        <!-- Main Content Area -->
        <div class="main-content-area">
            <!-- Top Navigation -->
            {% include 'navbar.html' %}
            
            <!-- Main Content -->
            <main class="main-content">
                {% if messages %}
                    <div class="messages-container">
                        {% for message in messages %}
                            <div class="message-alert message-{{ message.tags|default:'info' }}" role="alert">
                                <div class="message-content">
                                    <i class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %} message-icon"></i>
                                    {{ message }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                      
        
                
                <!-- Content -->
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>
    

    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Theme Toggle JavaScript -->
    <script src="{% static 'js/theme-toggle.js' %}"></script>
    
    <!-- Custom JavaScript -->
    <script src="{% static 'js/main.js' %}"></script>
    
    <!-- Unified Date Utilities JavaScript -->
    <script src="{% static 'js/unified_date_utils.js' %}"></script>
    
    <!-- Universal Keyboard Navigation -->
    <script src="{% static 'js/universal-keyboard-navigation.js' %}"></script>
    
    <!-- Global Auto-Focus Script -->
    <script src="{% static 'js/auto-focus.js' %}"></script>
    

    
    <!-- Enhanced Universal ESC Navigation System -->
    <script>
        let inputHistory = [];
        let currentInputIndex = -1;
        let inputValues = new Map(); // Store input values
        
        // Save input value when it changes
        function saveInputValue(element) {
            if (element && (element.matches('input, textarea, select'))) {
                const key = getElementKey(element);
                inputValues.set(key, {
                    value: element.value,
                    selectionStart: element.selectionStart || 0,
                    selectionEnd: element.selectionEnd || 0
                });
            }
        }
        
        // Generate unique key for element
        function getElementKey(element) {
            return element.name || element.id || element.className || element.tagName + '_' + Array.from(element.parentNode.children).indexOf(element);
        }
        
        // Restore input value and cursor position
        function restoreInputValue(element) {
            const key = getElementKey(element);
            const saved = inputValues.get(key);
            if (saved) {
                element.value = saved.value;
                if (element.setSelectionRange && saved.selectionStart !== undefined) {
                    setTimeout(() => {
                        element.setSelectionRange(saved.selectionStart, saved.selectionEnd);
                    }, 0);
                }
            }
        }
        
        // Track input focus and save values
        document.addEventListener('focusin', function(e) {
            const element = e.target;
            if (element.matches('input, textarea, select')) {
                // Save current value when focusing
                saveInputValue(element);
                
                // Remove element if already in history to avoid duplicates
                const existingIndex = inputHistory.findIndex(item => item.element === element);
                if (existingIndex !== -1) {
                    inputHistory.splice(existingIndex, 1);
                }
                
                // Add current element to history
                inputHistory.push({
                    element: element,
                    timestamp: Date.now(),
                    key: getElementKey(element)
                });
                
                // Keep unlimited history (remove the 10 limit)
                // No limit on history size for unlimited navigation
                
                currentInputIndex = inputHistory.length - 1;
            }
        });
        
        // Save values on input change
        document.addEventListener('input', function(e) {
            if (e.target.matches('input, textarea, select')) {
                saveInputValue(e.target);
            }
        });
        
        // Save values on change event
        document.addEventListener('change', function(e) {
            if (e.target.matches('input, textarea, select')) {
                saveInputValue(e.target);
            }
        });
        
        // Universal ESC key navigation with unlimited backward navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Check if we're in a modal or special context first
                const activeModals = document.querySelectorAll('.modal:not([style*="display: none"]), .modal-overlay:not([style*="display: none"]), .quick-search-overlay, .batch-modal-overlay');
                
                if (activeModals.length > 0) {
                    // Let existing modal handlers deal with ESC
                    return;
                }
                
                // Navigate to previous input if available (unlimited backward navigation)
                if (inputHistory.length > 1 && currentInputIndex > 0) {
                    e.preventDefault();
                    
                    // Save current input value before navigating
                    const currentElement = document.activeElement;
                    if (currentElement && currentElement.matches('input, textarea, select')) {
                        saveInputValue(currentElement);
                    }
                    
                    currentInputIndex--;
                    
                    const previousInput = inputHistory[currentInputIndex];
                    if (previousInput && previousInput.element && document.contains(previousInput.element)) {
                        // Focus without auto-scrolling to prevent interference
                        previousInput.element.focus({ preventScroll: true });
                        
                        // Only scroll if element is not visible
                        const rect = previousInput.element.getBoundingClientRect();
                        const isVisible = rect.top >= 0 && rect.bottom <= window.innerHeight;
                        
                        if (!isVisible) {
                            previousInput.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        
                        // Restore the saved value
                        restoreInputValue(previousInput.element);
                        
                        // Visual feedback
                        previousInput.element.style.boxShadow = '0 0 0 3px rgba(0, 123, 255, 0.3)';
                        setTimeout(() => {
                            if (previousInput.element) {
                                previousInput.element.style.boxShadow = '';
                            }
                        }, 500);
                        
                        // Show navigation info
                        showNavigationInfo(currentInputIndex + 1, inputHistory.length);
                    }
                } else if (inputHistory.length > 0 && currentInputIndex === 0) {
                    // At the beginning of history
                    e.preventDefault();
                    showNavigationInfo(1, inputHistory.length, 'At beginning of navigation history');
                }
                return;
            }
            
            // Ctrl+Shift for back navigation
            if (e.ctrlKey && e.shiftKey && !e.altKey) {
                e.preventDefault();
                window.history.back();
                return;
            }
            
            // Shift+ESC for forward navigation in input history
            if (e.key === 'Escape' && e.shiftKey) {
                e.preventDefault();
                
                // Navigate forward in input history
                if (inputHistory.length > 1 && currentInputIndex < inputHistory.length - 1) {
                    // Save current input value before navigating
                    const currentElement = document.activeElement;
                    if (currentElement && currentElement.matches('input, textarea, select')) {
                        saveInputValue(currentElement);
                    }
                    
                    currentInputIndex++;
                    
                    const nextInput = inputHistory[currentInputIndex];
                    if (nextInput && nextInput.element && document.contains(nextInput.element)) {
                        // Focus without auto-scrolling
                        nextInput.element.focus({ preventScroll: true });
                        
                        // Only scroll if element is not visible
                        const rect = nextInput.element.getBoundingClientRect();
                        const isVisible = rect.top >= 0 && rect.bottom <= window.innerHeight;
                        
                        if (!isVisible) {
                            nextInput.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        
                        // Restore the saved value
                        restoreInputValue(nextInput.element);
                        
                        // Visual feedback
                        nextInput.element.style.boxShadow = '0 0 0 3px rgba(0, 200, 0, 0.3)';
                        setTimeout(() => {
                            if (nextInput.element) {
                                nextInput.element.style.boxShadow = '';
                            }
                        }, 500);
                        
                        // Show navigation info
                        showNavigationInfo(currentInputIndex + 1, inputHistory.length);
                    }
                } else if (currentInputIndex === inputHistory.length - 1) {
                    // At the end of history
                    showNavigationInfo(inputHistory.length, inputHistory.length, 'At end of navigation history');
                }
                return;
            }
            
            // Ctrl+SI shortcut for Quick Invoice+Products
            if (e.ctrlKey && e.key === 's' && !e.shiftKey && !e.altKey) {
                e.preventDefault();
                // Check if next key is 'i'
                let nextKeyTimeout = setTimeout(() => {
                    clearTimeout(nextKeyTimeout);
                }, 500);
                
                document.addEventListener('keydown', function siHandler(e2) {
                    if (e2.key === 'i') {
                        clearTimeout(nextKeyTimeout);
                        document.removeEventListener('keydown', siHandler);
                        e2.preventDefault();
                        window.location.href = "{% url 'add_sales_invoice_with_products' %}";
                    } else {
                        document.removeEventListener('keydown', siHandler);
                    }
                }, { once: true });
            }
            
            // Alt shortcuts for reports and returns
            if (e.altKey && !e.ctrlKey && !e.shiftKey) {
                switch(e.key.toLowerCase()) {
                    case 'm':
                        e.preventDefault();
                        window.location.href = "{% url 'sales_report' %}";
                        break;
                    case 'n':
                        e.preventDefault();
                        window.location.href = "{% url 'purchase_report' %}";
                        break;
                    case 'v':
                        e.preventDefault();
                        window.location.href = "{% url 'financial_report' %}";
                        break;
                    case 'g':
                        e.preventDefault();
                        window.location.href = "{% url 'purchase_return_list' %}";
                        break;
                    case 'h':
                        e.preventDefault();
                        window.location.href = "{% url 'sales_return_list' %}";
                        break;
                    case 'u':
                        e.preventDefault();
                        window.location.href = "{% url 'low_stock_update' %}";
                        break;
                }
            }
        });
        
        // Clean up input history when elements are removed from DOM
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList' && mutation.removedNodes.length > 0) {
                    inputHistory = inputHistory.filter(item => 
                        item.element && document.contains(item.element)
                    );
                    
                    // Reset index if it's out of bounds
                    if (currentInputIndex >= inputHistory.length) {
                        currentInputIndex = inputHistory.length - 1;
                    }
                }
            });
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    </script>
    
    {% block extra_js %}{% endblock %}
    
    <!-- Loading Screen Styles and Script -->
    <style>
    .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999999;
        transition: opacity 0.8s ease-out;
        overflow: hidden;
    }
    
    .loading-screen::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 30% 70%, rgba(76, 175, 80, 0.2) 0%, transparent 50%),
                    radial-gradient(circle at 70% 30%, rgba(33, 150, 243, 0.2) 0%, transparent 50%);
        animation: backgroundPulse 4s ease-in-out infinite;
    }
    
    @keyframes backgroundPulse {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 0.7; }
    }
    
    .loader-container {
        text-align: center;
        color: white;
        position: relative;
    }
    
    .loading-text {
        margin-top: 30px;
        font-size: 1.8rem;
        font-weight: 700;
        background: linear-gradient(90deg, #4CAF50, #2196F3, #9C27B0);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: textGlow 2s ease-in-out infinite alternate;
        letter-spacing: 2px;
    }
    
    .loading-subtitle {
        margin-top: 15px;
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 400;
        animation: fadeInOut 2s ease-in-out infinite;
    }
    
    @keyframes textGlow {
        0% { 
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
            transform: scale(1);
        }
        100% { 
            text-shadow: 0 0 20px rgba(33, 150, 243, 0.8);
            transform: scale(1.02);
        }
    }
    
    @keyframes fadeInOut {
        0%, 100% { opacity: 0.7; }
        50% { opacity: 1; }
    }
    
    #loadingScreen .pharma-logo-main,
    #loadingScreen .loader-logo {
        width: 120px !important;
        height: 120px !important;
        margin: 0 auto !important;
        animation: loaderSpin 2s linear infinite;
        position: relative;
        z-index: 100000;
        max-width: none !important;
        max-height: none !important;
        transform-origin: center;
        filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.3));
    }
    
    /* Fix loader elements positioning */
    #loadingScreen .medical-cross {
        width: 48px !important;
        height: 48px !important;
        position: absolute !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        z-index: 5 !important;
    }
    
    #loadingScreen .cross-vertical {
        width: 16px !important;
        height: 48px !important;
    }
    
    #loadingScreen .cross-horizontal {
        width: 48px !important;
        height: 16px !important;
    }
    
    #loadingScreen .pills-orbit {
        position: absolute !important;
        width: 100% !important;
        height: 100% !important;
        top: 0 !important;
        left: 0 !important;
    }
    
    #loadingScreen .pill {
        width: 24px !important;
        height: 12px !important;
        border-radius: 12px !important;
        position: absolute !important;
        top: 50% !important;
        left: 50% !important;
        z-index: 3 !important;
    }
    
    #loadingScreen .pill-1 {
        transform: translate(-50%, -50%) rotate(0deg) translateX(50px) !important;
        animation: pillFloat 4s ease-in-out infinite, pillOrbit1 6s linear infinite !important;
    }
    
    #loadingScreen .pill-2 {
        transform: translate(-50%, -50%) rotate(120deg) translateX(50px) !important;
        animation: pillFloat 4s ease-in-out infinite 1.3s, pillOrbit2 7s linear infinite !important;
    }
    
    #loadingScreen .pill-3 {
        transform: translate(-50%, -50%) rotate(240deg) translateX(50px) !important;
        animation: pillFloat 4s ease-in-out infinite 2.6s, pillOrbit3 8s linear infinite !important;
    }
    
    #loadingScreen .pulse-ring {
        position: absolute !important;
        top: 50% !important;
        left: 50% !important;
        border: 4px solid rgba(0, 230, 118, 0.3) !important;
        border-radius: 50% !important;
        transform: translate(-50%, -50%) !important;
    }
    
    #loadingScreen .ring-1 {
        width: 70px !important;
        height: 70px !important;
    }
    
    #loadingScreen .ring-2 {
        width: 90px !important;
        height: 90px !important;
    }
    
    #loadingScreen .ring-3 {
        width: 110px !important;
        height: 110px !important;
    }
    
    /* Override any responsive styles for loading screen */
    @media (max-width: 768px) {
        #loadingScreen .pharma-logo-main,
        #loadingScreen .loader-logo {
            width: 100px !important;
            height: 100px !important;
        }
        
        #loadingScreen .medical-cross {
            width: 40px !important;
            height: 40px !important;
        }
        
        #loadingScreen .cross-vertical {
            width: 12px !important;
            height: 40px !important;
        }
        
        #loadingScreen .cross-horizontal {
            width: 40px !important;
            height: 12px !important;
        }
        
        #loadingScreen .pill {
            width: 20px !important;
            height: 10px !important;
        }
        
        #loadingScreen .pill-1,
        #loadingScreen .pill-2,
        #loadingScreen .pill-3 {
            transform: translate(-50%, -50%) rotate(var(--rotation, 0deg)) translateX(42px) !important;
        }
        
        #loadingScreen .ring-1 {
            width: 60px !important;
            height: 60px !important;
        }
        
        #loadingScreen .ring-2 {
            width: 75px !important;
            height: 75px !important;
        }
        
        #loadingScreen .ring-3 {
            width: 90px !important;
            height: 90px !important;
        }
    }
    
    @media (max-width: 480px) {
        #loadingScreen .pharma-logo-main,
        #loadingScreen .loader-logo {
            width: 80px !important;
            height: 80px !important;
        }
        
        #loadingScreen .medical-cross {
            width: 32px !important;
            height: 32px !important;
        }
        
        #loadingScreen .cross-vertical {
            width: 10px !important;
            height: 32px !important;
        }
        
        #loadingScreen .cross-horizontal {
            width: 32px !important;
            height: 10px !important;
        }
        
        #loadingScreen .pill {
            width: 16px !important;
            height: 8px !important;
        }
        
        #loadingScreen .pill-1,
        #loadingScreen .pill-2,
        #loadingScreen .pill-3 {
            transform: translate(-50%, -50%) rotate(var(--rotation, 0deg)) translateX(35px) !important;
        }
        
        #loadingScreen .ring-1 {
            width: 50px !important;
            height: 50px !important;
        }
        
        #loadingScreen .ring-2 {
            width: 65px !important;
            height: 65px !important;
        }
        
        #loadingScreen .ring-3 {
            width: 80px !important;
            height: 80px !important;
        }
    }
    

    
    @keyframes loaderSpin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @keyframes pillOrbit1 {
        0% { transform: translate(-50%, -50%) rotate(0deg) translateX(50px) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg) translateX(50px) rotate(-360deg); }
    }
    
    @keyframes pillOrbit2 {
        0% { transform: translate(-50%, -50%) rotate(120deg) translateX(50px) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(480deg) translateX(50px) rotate(-360deg); }
    }
    
    @keyframes pillOrbit3 {
        0% { transform: translate(-50%, -50%) rotate(240deg) translateX(50px) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(600deg) translateX(50px) rotate(-360deg); }
    }
    

    
    .loading-screen.fade-out {
        opacity: 0;
        pointer-events: none;
    }
    </style>
    
    <script>
    // Hide loading screen and show main content
    window.addEventListener('load', function() {
        setTimeout(function() {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContainer = document.getElementById('mainContainer');
            
            loadingScreen.classList.add('fade-out');
            mainContainer.style.display = 'flex';
            
            setTimeout(function() {
                loadingScreen.style.display = 'none';
            }, 500);
        }, 1000);
    });
    </script>
</body>
</html>